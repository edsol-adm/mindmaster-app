<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MindMaster – Storytime (Sequence Builder)</title>
<style>
  :root{
    --bg: #FFB6C1; /* light pink */
    --card: #ffffff;
    --ink: #222222;
    --muted: #555555;
    --accent: #FF8AAE;
    --accent-2:#FFD700; /* yellow buttons */
    --good:#6AC47E;
    --bad:#F45B69;
    --diff:#5BA3F4;
    --shadow: 0 6px 16px rgba(0,0,0,.15);
    --radius: 18px;
  }
  *{ box-sizing: border-box; }
  html, body{ margin:0; height:100%; font-family:"Comic Neue","Fredoka",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink); background:var(--bg); overflow-x:hidden; }
  .container{ max-width:1100px; margin:0 auto; padding:16px; }
  .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); }
  .center{ display:flex; align-items:center; justify-content:center; }
  .hidden{ display:none !important; }
  .row{ display:flex; gap:12px; flex-wrap:wrap; }

  /* Intro */
  #screen-intro{ min-height:100dvh; padding:32px; background:var(--bg); background-image:url('assets/storytime/images/ui/bg-launch.png'); background-size:cover; background-position:center; }
  .intro-card{ max-width:780px; padding:24px 28px; text-align:center; background:#fffdfdd9; }
  h1{ margin:8px 0 2px; font-size:28px; line-height:1.2; }
  p.lead{ margin:6px 0 14px; font-size:18px; color:var(--muted); }
  .btn{ appearance:none; border:none; padding:12px 18px; border-radius:999px; font-weight:700; font-size:16px; cursor:pointer; box-shadow:var(--shadow); transition:transform .12s ease, filter .2s ease; background:var(--accent-2); color:#222; text-decoration:none; display:inline-block; }
  .button-secondary{ background:#fff; color:#222; border:2px solid #222; }
  .btn:hover{ transform:translateY(-1px) scale(1.02); filter:brightness(1.03); }
  .btn:active{ transform:translateY(1px) scale(.98); }
  /* Navigation-standard focus outline for anchors styled as buttons */
  .btn.nav:focus{ outline:4px solid #000; outline-offset:2px; }

  /* Unit pill */
  .unit-pill{
    display:inline-block;
    padding:6px 12px;
    border-radius:999px;
    font-weight:700;
    font-size:.95rem;
    background:#fcba03;
    border:2px solid #222;
    margin-bottom:8px;
  }

  /* Game */
  #screen-game{ min-height:100dvh; padding:16px; }
  .stage{ display:grid; grid-template-rows:auto 1fr auto; gap:16px; }
  .strip{ display:grid; grid-template-columns:repeat(5,1fr); gap:14px; padding:12px; background:rgba(255,255,255,.7); border-radius:var(--radius); box-shadow:var(--shadow); }
  .slotWrap{ display:flex; flex-direction:column; gap:6px; }
  .slot{ position:relative; background:#fff; border-radius:14px; height:180px; border:2px dashed rgba(0,0,0,.1); overflow:hidden; transition:box-shadow .2s, border-color .2s; }
  .slot.active{ border-color:rgba(0,0,0,.25); box-shadow:0 0 0 3px rgba(0,0,0,.06) inset, 0 0 0 3px var(--accent) inset; }
  .slot .caption{ position:absolute; left:8px; right:8px; bottom:28px; background:#fff; color:#000; padding:6px 8px; border-radius:10px; font-size:16px; line-height:1.3; box-shadow:0 3px 10px rgba(0,0,0,.12); opacity:0; transform:translateY(8px); transition:all .25s ease; }
  .slot.filled .caption{ opacity:1; transform:translateY(0); }
  .slotPrompt{ min-height:20px; text-align:center; font-size:16px; font-style:italic; color:var(--muted); opacity:0; transform:translateY(-4px); transition:all .2s ease; }
  .slotWrap.showPrompt .slotPrompt{ opacity:1; transform:translateY(0); }

  .deck{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:center; padding:10px; }
  .card-img{ width:140px; height:140px; border-radius:16px; background:#fff; box-shadow:var(--shadow); display:flex; align-items:center; justify-content:center; overflow:hidden; cursor:grab; user-select:none; position:relative; transition:transform .2s ease; touch-action:manipulation; }
  .card-img img{ width:100%; height:100%; object-fit:contain; pointer-events:none; }
  .card-img:active{ cursor:grabbing; }
  .floaty{ animation:floaty 3s ease-in-out infinite; }
  @keyframes floaty{ 0%{ transform:translateY(0) rotate(-.6deg);} 50%{ transform:translateY(-6px) rotate(.6deg);} 100%{ transform:translateY(0) rotate(-.6deg);} }
  .shake{ animation:shake .35s ease; }
  @keyframes shake{ 0%,100%{ transform:translateX(0);} 20%{ transform:translateX(-8px);} 40%{ transform:translateX(8px);} 60%{ transform:translateX(-6px);} 80%{ transform:translateX(6px);} }
  .pop-in{ animation:pop .28s ease; }
  @keyframes pop{ from{ transform:scale(.92);} to{ transform:scale(1);} }
  .glow{ animation:glow 1200ms ease-in-out 2; }
  @keyframes glow{ 0%{ box-shadow:0 0 0 rgba(255,255,255,0);} 50%{ box-shadow:0 0 0 8px rgba(255,255,255,.6);} 100%{ box-shadow:var(--shadow);} }

  /* End */
  #screen-end{ min-height:100dvh; padding:24px; }
  .end-card{ max-width:820px; padding:24px 28px; text-align:center; }
  .tag{ display:inline-block; font-weight:700; padding:6px 12px; border-radius:999px; color:#fff; box-shadow:var(--shadow); margin-bottom:12px; }
  .tag.good{ background:var(--good);} .tag.bad{ background:var(--bad);} .tag.difficult{ background:var(--diff);}
  .btn-row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; }

  /* Tiny toast for sound hint */
  #soundTip{ position:fixed; left:12px; bottom:12px; background:#000; color:#fff; font-size:13px; padding:8px 10px; border-radius:12px; opacity:.85; box-shadow:0 6px 16px rgba(0,0,0,.25); }
</style>
</head>
<body>
  <!-- Intro -->
  <section id="screen-intro" class="center">
    <div class="card intro-card">
      <div class="unit-pill" aria-label="Unit title">Unit 5: Imagination and Storytelling</div>
      <h1>Story Sequence — Put the story cards in the right order</h1>
      <p class="lead">When you place a card, the caption appears — and under that card we show the matching prompt.</p>
      <div class="row center" style="gap:8px;">
        <button class="btn" id="btn-start">Start</button>
        <button class="btn button-secondary" id="btn-how">How to play</button>
        <a class="btn button-secondary nav" href="lesson-screen-htmls/lesson-05.01.html">Return to the Park</a>
      </div>
      <div id="howto" class="hidden" style="margin-top:12px;font-size:15px;color:#333;text-align:left;">
        <ul>
          <li>Drag a card from the bottom deck into the glowing slot.</li>
          <li>If it’s correct: it bounces in and shows a caption.</li>
          <li>Then a prompt appears under that same card (for that step).</li>
          <li>Finish all 5 to complete the story.</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Game -->
  <section id="screen-game" class="hidden">
    <div class="container">
      <div class="stage">
        <div id="strip" class="strip"></div>
        <div id="deck" class="deck"></div>
      </div>
    </div>
  </section>

  <!-- End -->
  <section id="screen-end" class="hidden center">
    <div class="card end-card">
      <div id="endTag" class="tag">Story</div>
      <h2 style="margin:6px 0 8px;">Well done!</h2>
      <p id="endMessage" style="font-size:18px;margin:0 0 10px;"></p>
      <p style="font-size:16px;color:#555;">Do you want to play the next story?</p>
      <div class="btn-row">
        <button class="btn" id="btn-next">Next Story</button>
        <button class="btn" id="btn-again">Play Again</button>
        <!-- Primary navigation via anchor per Navigation Standard -->
        <a id="btn-home" class="btn button-secondary nav" href="lesson-screen-htmls/lesson-06.02.html">Return to the Park</a>
      </div>
    </div>
  </section>

  <div id="soundTip" class="hidden">Tap anywhere to enable sound</div>

<script>
/* ===== STORY DATA ===== */
const storyData = {
  good: {
    color: 'good',
    images: [
      "assets/storytime/good/good-1.png",
      "assets/storytime/good/good-2.png",
      "assets/storytime/good/good-3.png",
      "assets/storytime/good/good-4.png",
      "assets/storytime/good/good-5.png"
    ],
    captions: [
      "Paulo helps his mum with the chores",
      "Mum is happy and bakes a cake for Paulo",
      "Paulo asks his friends round and they share the cake",
      "After having the cake they go out to play",
      "Everyone is happy"
    ],
    prompts: [
      "What happens next?",
      "What does Paulo do with the cake?",
      "What do Paulo and his friends do next?",
      "What happens next?",
      ""
    ],
    endMessage: "Helping others makes everyone happy."
  },
  bad: {
    color: 'bad',
    images: [
      "assets/storytime/bad/bad-1.png",
      "assets/storytime/bad/bad-2.png",
      "assets/storytime/bad/bad-3.png",
      "assets/storytime/bad/bad-4.png",
      "assets/storytime/bad/bad-5.png"
    ],
    captions: [
      "Natt breaks Prang’s lego castle",
      "Natt and Prang are angry. Natt wants to fight with Prang",
      "Prang tells the teacher what happened",
      "Teacher helps Prang and Natt build a new castle",
      "Prang and Natt are friends again"
    ],
    prompts: [
      "What will Prang do?",
      "What should Prang do?",
      "What will the teacher do next?",
      "What happens next?",
      ""
    ],
    endMessage: "We can fix problems together."
  },
  difficult: {
    color: 'difficult',
    images: [
      "assets/storytime/difficult/difficult-1.png",
      "assets/storytime/difficult/difficult-2.png",
      "assets/storytime/difficult/difficult-3.png",
      "assets/storytime/difficult/difficult-4.png",
      "assets/storytime/difficult/difficult-5.png"
    ],
    captions: [
      "Tangmo can’t ride her bike yet and falls off.",
      "Tangmo has another accident",
      "Dad helps Tangmo to learn to ride her bike",
      "Tangmo can ride her bike now – Dad is happy too",
      "Tangmo can ride with her friends any time now."
    ],
    prompts: [
      "Does she give up?",
      "Does she give up THIS time?",
      "What happens next?",
      "What does Tangmo do next?",
      ""
    ],
    endMessage: "Keep trying — you can do it."
  }
};

/* ===== AUDIO (mp3; robust autoplay unlock) ===== */
const sounds = {
  bgm: new Audio("assets/audio/storytime-bgm.mp3"),
  complete: new Audio("audio/complete.mp3"),
  correct: new Audio("audio/correct.mp3"),
  wrong: new Audio("audio/wrong.mp3")
};
sounds.bgm.loop = true;
sounds.bgm.volume = 0;

const soundTip = document.getElementById('soundTip');
let audioUnlocked = false;
function tryStartBgm(){
  sounds.bgm.volume = 0;
  return sounds.bgm.play().then(()=>{
    audioUnlocked = true;
    fadeIn(sounds.bgm, 1200, 0.25);
    soundTip.classList.add('hidden');
  }).catch(()=>{
    // show hint and add one-time unlock listener
    soundTip.classList.remove('hidden');
    const unlock = ()=>{
      sounds.bgm.play().then(()=>{
        audioUnlocked = true;
        fadeIn(sounds.bgm, 1200, 0.25);
        soundTip.classList.add('hidden');
        window.removeEventListener('pointerdown', unlock);
      }).catch(()=>{});
    };
    window.addEventListener('pointerdown', unlock, { once:false });
  });
}
function fadeIn(audio, duration = 1000, target = 0.25) {
  audio.volume = 0;
  const steps = 20, step = target / steps, tick = duration / steps;
  let i = 0; const id = setInterval(() => {
    i++; audio.volume = Math.min(target, audio.volume + step);
    if (i >= steps){ clearInterval(id); }
  }, tick);
}
function playWithFade(audioElement, fadeDuration = 900) {
  audioElement.currentTime = 0;
  audioElement.volume = 1;
  audioElement.play().catch(()=>{});
  setTimeout(() => {
    const steps = 16, step = 1 / steps, tick = fadeDuration / steps;
    let i = 0; const id = setInterval(() => {
      i++; audioElement.volume = Math.max(0, audioElement.volume - step);
      if (i >= steps) { clearInterval(id); }
    }, tick);
  }, 200);
}

/* ===== GAME STATE ===== */
let scenarioKey = null;
let currentIndex = 0; // 0..4
let order = [];
let placed = [false,false,false,false,false];
const scenarioKeys = Object.keys(storyData);

const elIntro = document.getElementById('screen-intro');
const elGame  = document.getElementById('screen-game');
const elEnd   = document.getElementById('screen-end');
const strip   = document.getElementById('strip');
const deck    = document.getElementById('deck');
const btnStart = document.getElementById('btn-start');
const btnHow = document.getElementById('btn-how');
const howto = document.getElementById('howto');
const btnAgain = document.getElementById('btn-again');
const btnNext  = document.getElementById('btn-next');
const btnHome  = document.getElementById('btn-home');
const endTag = document.getElementById('endTag');
const endMessage = document.getElementById('endMessage');

btnHow.addEventListener('click', ()=> howto.classList.toggle('hidden'));
btnStart.addEventListener('click', () => { tryStartBgm(); startGame(); });
btnAgain.addEventListener('click', () => startGame());
btnNext.addEventListener('click', () => startGame(nextScenarioKey(scenarioKey)));
/* Primary navigation now handled via anchor href.
   Keep an optional enhancement function (not used for primary nav). */
function goHome(){
  try{ sounds.bgm && sounds.bgm.pause(); }catch(e){}
  window.location.href = 'lesson-screen-htmls/lesson-06.02.html';
}

function showScreen(which){
  elIntro.classList.add('hidden'); elGame.classList.add('hidden'); elEnd.classList.add('hidden');
  if (which==='intro') elIntro.classList.remove('hidden');
  else if (which==='game') elGame.classList.remove('hidden');
  else elEnd.classList.remove('hidden');
}

function startGame(forcedKey=null){
  scenarioKey = forcedKey || pickScenario();
  currentIndex = 0; placed = [false,false,false,false,false];
  strip.innerHTML = ''; deck.innerHTML = '';
  showScreen('game');

  // Build slots (no prompt initially; prompt appears under placed card and stays)
  for (let i=0;i<5;i++){
    const wrap = document.createElement('div');
    wrap.className = 'slotWrap' + (i===0 ? ' active' : '');
    wrap.dataset.index = i;

    const s = document.createElement('div');
    s.className = 'slot' + (i===0 ? ' active' : '');
    s.dataset.index = i;

    const cap = document.createElement('div');
    cap.className = 'caption';
    cap.textContent = storyData[scenarioKey].captions[i];
    s.appendChild(cap);

    const prompt = document.createElement('div');
    prompt.className = 'slotPrompt';
    prompt.textContent = ''; // will fill under placed card i

    wrap.appendChild(s);
    wrap.appendChild(prompt);
    strip.appendChild(wrap);

    // Enable precise drop on each slot
    wrap.addEventListener('dragover', (e)=> e.preventDefault());
    wrap.addEventListener('drop', (e)=>{
      e.preventDefault();
      const cardIndex = Number(e.dataTransfer.getData('text/plain'));
      const cardEl = [...deck.children].find(c => Number(c.dataset.idx)===cardIndex);
      tryPlaceCard(cardEl, cardIndex);
    });
  }

  // Deck
  order = shuffle([0,1,2,3,4]);
  const imgs = storyData[scenarioKey].images;
  for (const idx of order){
    const card = makeCard(idx, imgs[idx]);
    deck.appendChild(card);
  }
}

function pickScenario(){ return scenarioKeys[Math.floor(Math.random()*scenarioKeys.length)]; }
function nextScenarioKey(key){ const i = scenarioKeys.indexOf(key); return scenarioKeys[(i+1)%scenarioKeys.length]; }

function makeCard(idx, src){
  const wrap = document.createElement('div');
  wrap.className = 'card-img floaty';
  wrap.draggable = true;
  wrap.dataset.idx = idx;

  const img = document.createElement('img');
  img.alt = 'story card ' + (idx+1);
  img.src = src;
  wrap.appendChild(img);

  // Drag & drop
  wrap.addEventListener('dragstart', (e)=>{
    e.dataTransfer.effectAllowed = "move";
    e.dataTransfer.setData('text/plain', String(idx));
    setTimeout(()=> wrap.classList.add('pop-in'), 0);
  });

  // Tap-to-place as fallback
  wrap.addEventListener('click', ()=> tryPlaceCard(wrap, idx));

  return wrap;
}

function ensureAudioUnlocked(){
  if (!audioUnlocked){
    tryStartBgm();
  }
}

function tryPlaceCard(cardEl, idx){
  if (!cardEl || placed[idx]) return;
  ensureAudioUnlocked();

  if (idx === currentIndex){
    placed[idx] = true;
    sounds.correct.currentTime = 0; sounds.correct.play().catch(()=>{});

    const wrap = strip.children[idx];
    const targetSlot = wrap.querySelector('.slot');
    cardEl.classList.remove('floaty','shake');
    cardEl.style.transition = 'transform .25s ease'; cardEl.classList.add('pop-in');

    targetSlot.innerHTML = '';
    const img = document.createElement('img');
    img.src = storyData[scenarioKey].images[idx];
    img.alt = 'story frame ' + (idx+1);
    img.style.width='100%'; img.style.height='100%'; img.style.objectFit='contain';
    targetSlot.appendChild(img);

    const cap = document.createElement('div');
    cap.className = 'caption'; cap.textContent = storyData[scenarioKey].captions[idx];
    targetSlot.appendChild(cap);
    requestAnimationFrame(()=> targetSlot.classList.add('filled'));

    // Show the prompt for THIS card (index i) under this card and keep it
    const promptEl = wrap.querySelector('.slotPrompt');
    promptEl.textContent = storyData[scenarioKey].prompts[idx] || '';
    wrap.classList.add('showPrompt');

    cardEl.remove();

    // advance and highlight the next empty slot (no prompt there)
    currentIndex++;
    if (currentIndex>=5){
      onComplete();
    } else {
      Array.from(strip.children).forEach((w, i)=>{
        const slot = w.querySelector('.slot');
        slot.classList.toggle('active', i===currentIndex && !placed[i]);
      });
    }
  } else {
    // wrong
    cardEl.classList.remove('shake'); void cardEl.offsetWidth; cardEl.classList.add('shake');
    sounds.wrong.currentTime = 0; sounds.wrong.play().catch(()=>{});
  }
}

function onComplete(){
  strip.classList.add('glow'); setTimeout(()=> strip.classList.remove('glow'), 1400);
  playWithFade(sounds.complete, 900);
  setTimeout(()=>{
    endTag.textContent = scenarioKey[0].toUpperCase() + scenarioKey.slice(1);
    endTag.className = 'tag ' + storyData[scenarioKey].color;
    endMessage.textContent = storyData[scenarioKey].endMessage;
    showScreen('end');
  }, 900);
}

/* Utils */
function shuffle(a){ const arr=a.slice(); for (let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

/* Screens (last definition takes effect) */
function showScreen(which){
  elIntro.classList.add('hidden'); elGame.classList.add('hidden'); elEnd.classList.add('hidden');
  if (which==='intro') elIntro.classList.remove('hidden');
  else if (which==='game') elGame.classList.remove('hidden');
  else elEnd.classList.remove('hidden');
}
</script>

<!--
Sources referenced for layout & navigation parity with the reference file and standard:
:contentReference[oaicite:0]{index=0}
:contentReference[oaicite:1]{index=1}
-->
</body>
</html>
