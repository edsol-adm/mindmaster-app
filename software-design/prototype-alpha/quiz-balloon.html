<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Quiz Balloon ‚Äî Levels 1‚Äì5</title>
<style>
#btnPlusImg,
#btnMinusImg {
  display: block;
  object-fit: contain;
}

  :root{
    --play:800px;
    --border:12px;
    --radius:24px;
    --basketLaneH:220px;
    --popY:800px;
    --spawnY:-80px;
    --focus:4px;
    --accent:#4F46E5;
    --good:#10B981;
    --bad:#EF4444;
    --text:#111827;
    --muted:#6B7280;
    --balloonBase: 500px;
    --balloonScaleBase: .42;
    --balloonScaleFactor: 0.68;
    --balloonScale: calc(var(--balloonScaleBase) * var(--balloonScaleFactor));
    --balloonSize: calc(var(--balloonBase) * var(--balloonScale));
    --txtW: calc(360px * var(--balloonScale));
    --txtH: calc(220px * var(--balloonScale));
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#ffe4ec;color:#111;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{max-width:1000px;margin:16px auto 8px auto;padding:0 12px;text-align:center}
  header h1{font-size:20px;margin:0 0 6px 0;font-weight:700}
  header p{margin:0;font-size:14px;color:var(--muted)}
  .wrap{display:flex;gap:16px;justify-content:center;align-items:flex-start;flex-wrap:wrap;margin:8px auto 24px auto;width:100%;padding:0 12px}
  .play-area{
    position:relative;
    width:min(1920px,99vw);
    height:clamp(520px, 72vh, 900px);
    background:#fff;
    border:var(--border) solid #a78bfa;
    border-radius:var(--radius);
    overflow:hidden;
    box-shadow:0 8px 30px rgba(0,0,0,.08);
  }
  .hud{
    position:absolute;left:0;top:0;width:100%;display:flex;justify-content:space-between;align-items:center;padding:8px 12px;pointer-events:none;z-index:4
  }
  .hud .timer,.hud .score{font-weight:700;background:rgba(255,255,255,.8);padding:4px 8px;border-radius:999px;border:2px solid #e5e7eb}
  .hud .timer{margin-left:8px}
  .hud .score{margin-right:8px}
  .balloon-layer{position:absolute;left:0;top:0;width:100%;height:100%}
  .baskets{position:absolute;left:0;top:0;width:100%;height:100%;display:block;z-index:3}
  .basket{
    position:absolute;width:240px;height:180px;left:0;bottom:0;display:grid;place-items:end center;user-select:none
  }
  .basket img{max-width:100%;max-height:100%;object-fit:contain;display:block}
  .basket.fallback{
    background:linear-gradient(#e5e7eb,#d1d5db);
    border-top-left-radius:24px;border-top-right-radius:24px;
    border:3px solid #9ca3af;border-bottom:none
  }
  .basket .label{
    position:absolute;top:8px;left:50%;transform:translateX(-50%);
    background:#111827;color:#fff;font-size:14px;padding:2px 8px;border-radius:999px;border:2px solid #fff;white-space:nowrap
  }
  .controls{
    display:flex;gap:12px;flex-wrap:wrap;justify-content:center;align-items:center;
    width:min(1920px,99vw);margin:12px auto
  }
  .controls img, .controls button{
    width:72px;height:72px;border-radius:999px;border:3px solid #111827;background:#fff;display:grid;place-items:center
  }
  .controls button{font-weight:900;font-size:22px;cursor:pointer}
  .controls button:focus,.btn:focus{outline:var(--focus) solid #111827;outline-offset:2px}
  .hidden{display:none!important}
  .group-hidden{display:none!important}
  .overlay-start{
    position:absolute;inset:0;background:rgba(255,255,255,.92);display:grid;place-items:center;text-align:center;padding:24px;z-index:5
  }
  .overlay-start.hidden{opacity:0;pointer-events:none;transition:opacity .2s ease}
  .overlay-start .pane{
    background:#4338CA;color:#ffffff;border:2px solid #111827;border-radius:16px;padding:18px 22px;max-width:70%;
    box-shadow:0 10px 30px rgba(0,0,0,.1)
  }
  .overlay-start p{margin:0;font-size:14px;color:#ffffff}
  .balloon{
    position:absolute;width:var(--balloonSize);height:var(--balloonSize);
    left:calc(50% - (var(--balloonSize)/2));top:0;
    transform:translateY(var(--spawnY)) scale(.9);opacity:0;will-change:transform,opacity
  }
  .balloon svg{display:block;width:100%;height:100%}
  .balloon .txt{
    position:absolute;
    width:var(--txtW);
    height:var(--txtH);
    left:50%;
    top:50%;
    transform: translate(-50%, -50%);
    display:grid;
    place-items:center;
    text-align:center;
    padding:2px 6px;
    line-height:1.2;
    overflow:hidden;
    margin-top: -6%;
  }
  .balloon .txt span{display:block;max-width:100%;white-space:normal;word-break:normal;
  -webkit-hyphens: none;
  -ms-hyphens: none;
  overflow-wrap: normal;
}
  .results{
    position:absolute;inset:0;background:rgba(255,255,255,.95);display:grid;place-items:center;z-index:6
  }
  .results .card{
    width:min(680px,90%);background:#fff;border:3px solid #111827;border-radius:20px;padding:20px 20px 16px 20px;
    box-shadow:0 12px 40px rgba(0,0,0,.12)
  }
  .starburst{
    position:absolute;inset:0;pointer-events:none;opacity:0;animation:burst 2s ease-out forwards
  }
  @keyframes burst{
    0%{opacity:0;transform:scale(.6) rotate(0deg)}
    15%{opacity:1}
    100%{opacity:0;transform:scale(1.6) rotate(180deg)}
  }
  .burst-shape{
    position:absolute;left:50%;top:50%;width:24px;height:120px;background:conic-gradient(from 0deg,#f59e0b,#ef4444,#10b981,#3b82f6,#a855f7,#f59e0b);
    transform-origin:50% 100%
  }
  .burst-shape:nth-child(1){transform:translate(-50%,-50%) rotate(0deg)}
  .burst-shape:nth-child(2){transform:translate(-50%,-50%) rotate(45deg)}
  .burst-shape:nth-child(3){transform:translate(-50%,-50%) rotate(90deg)}
  .burst-shape:nth-child(4){transform:translate(-50%,-50%) rotate(135deg)}
  .burst-shape:nth-child(5){transform:translate(-50%,-50%) rotate(180deg)}
  .burst-shape:nth-child(6){transform:translate(-50%,-50%) rotate(225deg)}
  .burst-shape:nth-child(7){transform:translate(-50%,-50%) rotate(270deg)}
  .burst-shape:nth-child(8){transform:translate(-50%,-50%) rotate(315deg)}
  .tally{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:12px 0 8px 0}
  .tally .col{border:2px dashed #d1d5db;border-radius:12px;padding:10px}
  .tally h3{margin:0 0 8px 0;font-size:14px}
  .tally ul{list-style:none;margin:0;padding:0;max-height:120px;overflow:auto}
  .tally li{padding:2px 0;border-bottom:1px dotted #eee;font-size:13px}
  .btn-row{display:flex;justify-content:center;gap:12px;margin-top:6px}
  .btn{
    border:3px solid #111827;background:#fff;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;display:inline-block;text-decoration:none;color:inherit
  }
  .emoji-burst{
    position:absolute;font-size:28px;opacity:0;animation:rise .25s ease-out forwards;pointer-events:none
  }
  @keyframes rise{
    from{transform:translateY(0);opacity:0}
    to{transform:translateY(-24px);opacity:1}
  }
  .kbd{
    font-weight:700;border:2px solid #111827;border-radius:6px;padding:0 6px;background:#fff;display:inline-block
  }

  #mimi-nudge{position:absolute;top:12px;right:12px;z-index:4}
  #mimi-nudge .mimi-avatar{width:96px;height:96px;position:relative;margin-left:auto}
  #mimi-nudge .mimi-avatar img{display:block;width:96px;height:96px;object-fit:contain;border-radius:12px;border:2px solid #111827;background:#fff}
  #mimi-nudge .mimi-avatar.fallback{display:grid;place-items:center;width:96px;height:96px;border-radius:999px;background:#c7d2fe;color:#111827;border:2px solid #111827;font-weight:900}
  #mimi-nudge .mimi-bubble{position:relative;margin-top:8px;background:#fff;border:2px solid #111827;border-radius:16px;padding:12px 14px;max-width:320px;line-height:1.35;font-size:1.1em}
  #mimi-nudge .mimi-bubble::after{content:"";position:absolute;top:-10px;right:18px;border-width:10px;border-style:solid;border-color:transparent transparent #111827 transparent}
  #mimi-nudge .mimi-bubble::before{content:"";position:absolute;top:-8px;right:20px;border-width:10px;border-style:solid;border-color:transparent transparent #fff transparent}

  #mimi-nudge .mimi-bubble.compact{font-size:.9em;line-height:1.2;padding:6px 10px}

/* Mimi instruction bubble (Next Level), mirror #mimi-nudge */
#mimi-instruction{position:absolute;top:12px;right:12px;z-index:5}
#mimi-instruction .mimi-avatar{width:96px;height:96px;position:relative;margin-left:auto}
#mimi-instruction .mimi-avatar img{display:block;width:96px;height:96px;object-fit:contain;border-radius:12px;border:2px solid #111827;background:#fff}
#mimi-instruction .mimi-avatar.fallback{display:grid;place-items:center;width:96px;height:96px;border-radius:999px;background:#c7d2fe;color:#111827;border:2px solid #111827;font-weight:900}
#mimi-instruction .mimi-bubble{position:relative;margin-top:8px;background:#fff;border:2px solid #111827;border-radius:16px;padding:12px 14px;max-width:320px;line-height:1.35;font-size:1.1em}
#mimi-instruction .mimi-bubble::after{content:"";position:absolute;top:-10px;right:18px;border-width:10px;border-style:solid;border-color:transparent transparent #111827 transparent}
#mimi-instruction .mimi-bubble::before{content:"";position:absolute;top:-8px;right:20px;border-width:10px;border-style:solid;border-color:transparent transparent #fff transparent}

</style>
</head>
<body>
<header>
  <h1>Which one is a Thought? ‚Äì which is a Feeling? ‚Äì which is an Action?</h1>
  <p>Click ‚ÄúT‚Äù for a Thought ‚Äì Click ‚ÄúF‚Äù for a Feeling ‚Äì Click ‚ÄúA‚Äù for an Action</p>
</header>
<div class="wrap">
  <div class="play-area" id="play">
    <div class="hud" id="hud"><div class="timer" id="timer">30.0</div><div class="score" id="score">Score: 0</div></div>
    <div class="balloon-layer" id="layer"></div>
    <div class="baskets" id="baskets"></div>
    <div class="overlay-start" id="overlayStart">
      <div class="pane">
        <p>Press any key to start game<br>Click ‚ÄúT‚Äù for a Thought ‚Äì Click ‚ÄúF‚Äù for a Feeling ‚Äì Click ‚ÄúA‚Äù for an Action</p>
      </div>
    </div>
    <div class="results hidden" id="results">
      <div class="starburst" id="burst">
        <div class="burst-shape"></div><div class="burst-shape"></div><div class="burst-shape"></div><div class="burst-shape"></div>
        <div class="burst-shape"></div><div class="burst-shape"></div><div class="burst-shape"></div><div class="burst-shape"></div>
      </div>
      <div class="card">
        <h2 style="margin:0 0 10px 0;font-size:22px">Round Complete</h2>
        <div style="font-size:18px;margin-bottom:8px">Final Score: <span id="finalScore">0</span></div>
        <div class="tally">
          <div class="col"><h3>Thoughts / Positive</h3><ul id="tally-thought"></ul></div>
          <div class="col"><h3>Feelings / Negative</h3><ul id="tally-feeling"></ul></div>
          <div class="col"><h3>Actions</h3><ul id="tally-action"></ul></div>
        </div>
        <div class="btn-row">
          <button class="btn" id="btnNext">Next Level</button>
          <button class="btn" id="btnAgain">Play Again</button>
          <a id="btnBack" class="btn back" href="lesson-screen-htmls/lesson-01.01.html">Back to the Park</a>
        </div>
      </div>
    </div>
  </div>
  <div class="controls" id="controls">
    <img id="btnTimg" alt="T" src="./assets/quiz-balloon/images/ui/btn-t.png" data-answer="thought">
    <img id="btnFimg" alt="F" src="./assets/quiz-balloon/images/ui/btn-f.png" data-answer="feeling">
    <img id="btnAimg" alt="A" src="./assets/quiz-balloon/images/ui/btn-a.png" data-answer="action">
    <button id="btnT" class="hidden" aria-label="Thought" data-answer="thought">T</button>
    <button id="btnF" class="hidden" aria-label="Feeling" data-answer="feeling">F</button>
    <button id="btnA" class="hidden" aria-label="Action" data-answer="action">A</button>

    <img id="btnPlusImg" alt="+" src="./assets/quiz-balloon/images/ui/btn-plus.png" data-answer="positive" >
    <img id="btnMinusImg" alt="-" src="./assets/quiz-balloon/images/ui/btn-minus.png" data-answer="negative" >
    <button id="btnPlus" class="hidden" aria-label="Positive" data-answer="positive">+</button>
    <button id="btnMinus" class="hidden" aria-label="Negative" data-answer="negative">‚àí</button>
  </div>
</div>
<audio id="bgm" src="./assets/audio/quiz-balloon-bgm.mp3" loop preload="auto"></audio>
<script>
  const ASSETS_ROOT='./assets/quiz-balloon/';
  const UI=ASSETS_ROOT+'images/ui/';
  const BASKETS=ASSETS_ROOT+'images/baskets/';
  const SFX=ASSETS_ROOT+'sounds/sfx/';
  const STIM=ASSETS_ROOT+'stimuli/';

  const LEVELS={
    1:{id:1,mode:'three',title:'Which one is a Thought? ‚Äì which is a Feeling? ‚Äì which is an Action?',instruction:'Click ‚ÄúT‚Äù for a Thought ‚Äì Click ‚ÄúF‚Äù for a Feeling ‚Äì Click ‚ÄúA‚Äù for an Action',allowSecond:true,streak:false,baskets:['thought','feeling','action']},
    2:{id:2,mode:'two',title:'What happened to them?',instruction:'Click ‚Äú+‚Äù for a nice experience ‚Äì Click ‚Äú‚Äì‚Äù for a not nice experience',allowSecond:false,streak:true,baskets:['positive','negative']},
    3:{id:3,mode:'two',title:'What did they feel?',instruction:'Click ‚Äú+‚Äù for a nice feeling ‚Äì Click ‚Äú‚Äì‚Äù for a nasty feeling',allowSecond:false,streak:true,baskets:['positive','negative']},
    4:{id:4,mode:'two',title:'What did they think?',instruction:'Click ‚Äú+‚Äù for a nice thought ‚Äì Click ‚Äú‚Äì‚Äù for a thought that doesn‚Äôt feel nice',allowSecond:false,streak:true,baskets:['positive','negative']},
    5:{id:5,mode:'two',title:'What did they do?',instruction:'Click ‚Äú+‚Äù for a kind action ‚Äì Click ‚Äú‚Äì‚Äù for an unkind action',allowSecond:false,streak:true,baskets:['positive','negative']}
  };

  const play=document.getElementById('play');
  const layer=document.getElementById('layer');
  const timerEl=document.getElementById('timer');
  const scoreEl=document.getElementById('score');
  const overlayStart=document.getElementById('overlayStart');
  const results=document.getElementById('results');
  const finalScore=document.getElementById('finalScore');
  const hudEl=document.getElementById('hud');
  const controlsEl=document.getElementById('controls');
  const tallyEls={thought:document.getElementById('tally-thought'),feeling:document.getElementById('tally-feeling'),action:document.getElementById('tally-action')};
  const tallyContainer = document.querySelector('.tally');
  const tallyCols = Array.from(tallyContainer.querySelectorAll('.col'));
  const tallyHeads = tallyCols.map(c => c.querySelector('h3'));

  const btnTimg=document.getElementById('btnTimg');const btnFimg=document.getElementById('btnFimg');const btnAimg=document.getElementById('btnAimg');
  const btnT=document.getElementById('btnT');const btnF=document.getElementById('btnF');const btnA=document.getElementById('btnA');
  const btnPlusImg=document.getElementById('btnPlusImg'); const btnMinusImg=document.getElementById('btnMinusImg');
  const btnPlus=document.getElementById('btnPlus'); const btnMinus=document.getElementById('btnMinus');

  const stimuliL1=[
  { id: 't01', text: 'Something good is coming', category: 'thought', valence: 'positive' },
  { id: 't02', text: 'I like causing trouble', category: 'thought', valence: 'negative' },
  { id: 't03', text: 'I can ask for help', category: 'thought', valence: 'positive' },
  { id: 't04', text: 'I always mess up', category: 'thought', valence: 'negative' },
  { id: 't05', text: 'I‚Äôll keep practicing', category: 'thought', valence: 'positive' },
  { id: 't06', text: 'Everyone is better than me', category: 'thought', valence: 'negative' },
  { id: 't07', text: 'I‚Äôm proud of what I did', category: 'thought', valence: 'positive' },
  { id: 't08', text: 'Everything is my fault', category: 'thought', valence: 'negative' },
  { id: 't09', text: 'I did my best', category: 'thought', valence: 'positive' },
  { id: 't10', text: 'I‚Äôm different to everyone else', category: 'thought', valence: 'negative' },

  { id: 'f01', text: 'She hates him', category: 'feeling', valence: 'positive' },
  { id: 'f02', text: 'He is jealous of her', category: 'feeling', valence: 'negative' },
  { id: 'f03', text: 'She trusts her', category: 'feeling', valence: 'positive' },
  { id: 'f04', text: 'I am confused', category: 'feeling', valence: 'negative' },
  { id: 'f05', text: 'He cares about me', category: 'feeling', valence: 'positive' },
  { id: 'f06', text: 'They are angry', category: 'feeling', valence: 'negative' },
  { id: 'f07', text: 'I am excited', category: 'feeling', valence: 'positive' },
  { id: 'f08', text: 'He is lonely', category: 'feeling', valence: 'negative' },
  { id: 'f09', text: 'They are confident', category: 'feeling', valence: 'positive' },
  { id: 'f10', text: 'He is afraid', category: 'feeling', valence: 'negative' },

  { id: 'a01', text: 'Play a fun game', category: 'action', valence: 'positive' },
  { id: 'a02', text: 'Break someone‚Äôs toy', category: 'action', valence: 'negative' },
  { id: 'a03', text: 'Help clean up', category: 'action', valence: 'positive' },
  { id: 'a04', text: 'Call someone a mean name', category: 'action', valence: 'negative' },
  { id: 'a05', text: 'Sing a funny song', category: 'action', valence: 'positive' },
  { id: 'a06', text: 'Start a fight', category: 'action', valence: 'negative' },
  { id: 'a07', text: 'Give a toy to a classmate', category: 'action', valence: 'positive' },
  { id: 'a08', text: 'Tell a lie', category: 'action', valence: 'negative' },
  { id: 'a09', text: 'Tell teacher if someone bullied', category: 'action', valence: 'positive' },
  { id: 'a10', text: 'Get someone in trouble', category: 'action', valence: 'negative' }
];

  const stimuliL2 = [
  { id: 'pos01', text: 'A happy home', category: 'event', valence: 'positive' },
  { id: 'pos02', text: 'Adults explain - don‚Äôt shout', category: 'event', valence: 'positive' },
  { id: 'pos03', text: 'A celebration together', category: 'event', valence: 'positive' },
  { id: 'pos04', text: 'Live in a nice area', category: 'event', valence: 'positive' },
  { id: 'pos05', text: 'Get a family pet', category: 'event', valence: 'positive' },
  { id: 'pos06', text: 'Get help when hurt', category: 'event', valence: 'positive' },
  { id: 'pos07', text: 'Friend stands up for me', category: 'event', valence: 'positive' },
  { id: 'pos08', text: 'Always have food at home', category: 'event', valence: 'positive' },
  { id: 'pos09', text: 'Feel safe at home and school', category: 'event', valence: 'positive' },
  { id: 'pos10', text: 'Have a big adventure', category: 'event', valence: 'positive' },

  { id: 'neg01', text: 'Not sure how mum will be', category: 'event', valence: 'negative' },
  { id: 'neg02', text: 'Lots of yelling at home', category: 'event', valence: 'negative' },
  { id: 'neg03', text: 'Teacher unkind when I need help', category: 'event', valence: 'negative' },
  { id: 'neg04', text: 'Have a big argument', category: 'event', valence: 'negative' },
  { id: 'neg05', text: 'Have to move home again', category: 'event', valence: 'negative' },
  { id: 'neg06', text: 'Favorite pet died', category: 'event', valence: 'negative' },
  { id: 'neg07', text: 'Lonely at school', category: 'event', valence: 'negative' },
  { id: 'neg08', text: 'Dad told me to tell a lie', category: 'event', valence: 'negative' },
  { id: 'neg09', text: 'My clothes have holes in', category: 'event', valence: 'negative' },
  { id: 'neg10', text: 'Teacher picks on me', category: 'event', valence: 'negative' }
];

const stimuliL3 = [
  { id: 'pos01', text: 'I am safe', category: 'feeling', valence: 'positive' },
  { id: 'pos02', text: 'She is calm', category: 'feeling', valence: 'positive' },
  { id: 'pos03', text: 'I trust him', category: 'feeling', valence: 'positive' },
  { id: 'pos04', text: 'He cares about her', category: 'feeling','valence': 'positive' },
  { id: 'pos05', text: 'They are relieved', category: 'feeling', valence: 'positive' },
  { id: 'pos06', text: 'I am excited', category: 'feeling', valence: 'positive' },
  { id: 'pos07', text: 'She is motivated', category: 'feeling', valence: 'positive' },
  { id: 'pos08', text: 'I am confident', category: 'feeling', valence: 'positive' },
  { id: 'pos09', text: 'She feels brave', category: 'feeling', valence: 'positive' },
  { id: 'pos10', text: 'I am appreciated', category: 'feeling', valence: 'positive' },

  { id: 'neg01', text: 'She is jealous', category: 'feeling', valence: 'negative' },
  { id: 'neg02', text: 'I am nervous', category: 'feeling', valence: 'negative' },
  { id: 'neg03', text: 'They are confused', category: 'feeling', valence: 'negative' },
  { id: 'neg04', text: 'He is angry', category: 'feeling', valence: 'negative' },
  { id: 'neg05', text: 'I feel lonely', category: 'feeling', valence: 'negative' },
  { id: 'neg06', text: 'We are afraid', category: 'feeling', valence: 'negative' },
  { id: 'neg07', text: 'I feel unsafe', category: 'feeling', valence: 'negative' },
  { id: 'neg08', text: 'She hates him', category: 'feeling', valence: 'negative' },
  { id: 'neg09', text: 'I am sad', category: 'feeling', valence: 'negative' },
  { id: 'neg10', text: 'He feels guilty', category: 'feeling', valence: 'negative' }
];

const stimuliL4 = [
  { id: 'pos01', text: 'Something good is coming', category: 'thought', valence: 'positive' },
  { id: 'pos02', text: 'I can ask for help', category: 'thought', valence: 'positive' },
  { id: 'pos03', text: 'Mistakes teach me', category: 'thought', valence: 'positive' },
  { id: 'pos04', text: 'I‚Äôll keep practicing', category: 'thought', valence: 'positive' },
  { id: 'pos05', text: 'I‚Äôm getting better', category: 'thought', valence: 'positive' },
  { id: 'pos06', text: 'Things will work out', category: 'thought', valence: 'positive' },
  { id: 'pos07', text: 'I‚Äôm proud of what I did', category: 'thought', valence: 'positive' },
  { id: 'pos08', text: 'I did my best', category: 'thought', valence: 'positive' },
  { id: 'pos09', text: 'That was kind of them', category: 'thought', valence: 'positive' },
  { id: 'pos10', text: 'People care about me', category: 'thought', valence: 'positive' },

  { id: 'neg01', text: 'I always mess up', category: 'thought', valence: 'negative' },
  { id: 'neg02', text: 'I can‚Äôt do this', category: 'thought', valence: 'negative' },
  { id: 'neg03', text: 'There‚Äôs no point trying', category: 'thought', valence: 'negative' },
  { id: 'neg04', text: 'Everyone is better than me', category: 'thought', valence: 'negative' },
  { id: 'neg05', text: 'Everything is my fault', category: 'thought', valence: 'negative' },
  { id: 'neg06', text: 'Things will never get better', category: 'thought', valence: 'negative' },
  { id: 'neg07', text: 'I‚Äôm in danger', category: 'thought', valence: 'negative' },
  { id: 'neg08', text: 'No one likes me', category: 'thought', valence: 'negative' },
  { id: 'neg09', text: 'I‚Äôm different to everyone else', category: 'thought', valence: 'negative' },
  { id: 'neg10', text: 'I hate them', category: 'thought', valence: 'negative' }
];

const stimuliL5 = [
  { id: 'pos01', text: 'Play a fun game', category: 'action', valence: 'positive' },
  { id: 'pos02', text: 'Paint a colorful picture', category: 'action', valence: 'positive' },
  { id: 'pos03', text: 'Help clean up', category: 'action', valence: 'positive' },
  { id: 'pos04', text: 'Sing a funny song', category: 'action', valence: 'positive' },
  { id: 'pos05', text: 'Give a toy to a classmate', category: 'action', valence: 'positive' },
  { id: 'pos06', text: 'Plant seeds in the garden', category: 'action', valence: 'positive' },
  { id: 'pos07', text: 'Tell teacher if someone bullied', category: 'action', valence: 'positive' },
  { id: 'pos08', text: 'Play with someone new to class', category: 'action', valence: 'positive' },
  { id: 'pos09', text: 'Help someone who‚Äôs hurt', category: 'action', valence: 'positive' },
  { id: 'pos10', text: 'Play sports today', category: 'action', valence: 'positive' },

  { id: 'neg01', text: 'Break someone‚Äôs toy', category: 'action', valence: 'negative' },
  { id: 'neg02', text: 'Cut in the line', category: 'action', valence: 'negative' },
  { id: 'neg03', text: 'Call someone a mean name', category: 'action', valence: 'negative' },
  { id: 'neg04', text: 'Start a fight', category: 'action', valence: 'negative' },
  { id: 'neg05', text: 'Laugh at someone‚Äôs mistake', category: 'action', valence: 'negative' },
  { id: 'neg06', text: 'Refuse to share', category: 'action', valence: 'negative' },
  { id: 'neg07', text: 'Tell a lie', category: 'action', valence: 'negative' },
  { id: 'neg08', text: 'Steal someone‚Äôs things', category: 'action', valence: 'negative' },
  { id: 'neg09', text: 'Have a tantrum', category: 'action', valence: 'negative' },
  { id: 'neg10', text: 'Get someone in trouble', category: 'action', valence: 'negative' }
];

  function fallMsFor(text){const words=text.trim().replace(/[^\w\s‚Äô']/g,'').split(/\s+/).filter(Boolean).length;if(words<=1)return 2500;if(words<=3)return 3750;return 5000}
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}

  const state={
    roundMs:30000,score:0,roundActive:false,current:null,freezeInput:false,
    timers:{fall:null,spawn:null,round:null,raf:null,roundDelay:null},
    log:{thought:[],feeling:[],action:[],positive:[],negative:[]},
    started:false,
    level:1,
    streak:0,
    wrongRun:0,
    mimiShownThisPlay:false,
    mimiTimer:null,
    mimiShownAt:0,
    showMimiIntroThisRound:false,
    roundClockStarted:false,
    roundClockDelayUntil:0
  };

  function applyLevelHeader(){
    const L=LEVELS[state.level];
    document.querySelector('header h1').textContent=L.title;
    document.querySelector('header p').textContent=L.instruction;
  }


function tryLoad(imgEl, src){
  return new Promise(res=>{
    imgEl.onload = () => {
      imgEl.classList.remove('hidden');
      if(imgEl.id === 'btnPlusImg'){
        const fb = document.getElementById('btnPlus');
        if(fb) fb.classList.add('hidden');
      }else if(imgEl.id === 'btnMinusImg'){
        const fb = document.getElementById('btnMinus');
        if(fb) fb.classList.add('hidden');
      }
      res(true);
    };
    imgEl.onerror = () => {
      imgEl.classList.add('hidden');
      if(imgEl.id === 'btnPlusImg'){
        const fb = document.getElementById('btnPlus');
        if(fb) fb.classList.remove('hidden');
      }else if(imgEl.id === 'btnMinusImg'){
        const fb = document.getElementById('btnMinus');
        if(fb) fb.classList.remove('hidden');
      }
      res(false);
    };
    imgEl.src = src;
    if (imgEl.complete && imgEl.naturalWidth > 0) {
      imgEl.onload();
    }
  });
}

  function ensureControls(){
    tryLoad(btnTimg,UI+'btn-t.png').then(ok=>{if(!ok)btnT.classList.remove('hidden')});
    tryLoad(btnFimg,UI+'btn-f.png').then(ok=>{if(!ok)btnF.classList.remove('hidden')});
    tryLoad(btnAimg,UI+'btn-a.png').then(ok=>{if(!ok)btnA.classList.remove('hidden')});
    tryLoad(btnPlusImg,UI+'btn-plus.png').then(ok=>{if(!ok)btnPlus.classList.remove('hidden')});
    tryLoad(btnMinusImg,UI+'btn-minus.png').then(ok=>{if(!ok)btnMinus.classList.remove('hidden')});
    [btnTimg,btnFimg,btnAimg,btnT,btnF,btnA].forEach(el=>el.classList.add('group-three'));
    [btnPlusImg,btnMinusImg,btnPlus,btnMinus].forEach(el=>el.classList.add('group-two'));
  }

  function applyLevelControls(){
    const isThree=(LEVELS[state.level].mode==='three');
    document.querySelectorAll('.group-three').forEach(el=>el.classList.toggle('group-hidden',!isThree));
    document.querySelectorAll('.group-two').forEach(el=>el.classList.toggle('group-hidden',isThree));
  }

  function renderBasketsForLevel(){
    const wrap=document.getElementById('baskets');
    wrap.innerHTML='';
    const keys=LEVELS[state.level].baskets.slice();
    const labelMap={thought:'Thought',feeling:'Feeling',action:'Action',positive:'Nice',negative:'Not Nice'};
    keys.forEach(k=>{
      const d=document.createElement('div');
      d.className='basket'; d.dataset.type=k; d.id='basket-'+k;
      const lab=document.createElement('span'); lab.className='label'; lab.textContent=labelMap[k]||k;
      d.appendChild(lab);
      wrap.appendChild(d);
    });
    ensureBasketsDynamic(keys);
    positionBaskets();
  }

  function ensureBasketsDynamic(keys){
    const files={thought:'basket-thought.png',feeling:'basket-feeling.png',action:'basket-action.png',positive:'basket-positive.png',negative:'basket-negative.png'};
    keys.forEach(k=>{
      const el=document.getElementById('basket-'+k); if(!el) return;
      if(!el.querySelector('img') && files[k]){
        const img=document.createElement('img'); img.alt=k+' basket'; img.src=BASKETS+files[k];
        img.onerror=()=>{el.classList.add('fallback'); img.remove();};
        img.onload =()=>{el.classList.remove('fallback');};
        el.appendChild(img);
      }else if(!files[k]){
        el.classList.add('fallback');
      }
    });
  }

  function positionBaskets(){
  const keys = LEVELS[state.level].baskets;
  const w = play.clientWidth;

  const centers = (keys.length === 3)
    ? [w * 0.12, w * 0.50, w * 0.88]
    : [w * 0.12, w * 0.88];

  const bw = 240, bh = 180;

  keys.forEach((k, i) => {
    const el = document.getElementById('basket-' + k); if (!el) return;

    el.style.position = 'absolute';
    el.style.width  = bw + 'px';
    el.style.height = bh + 'px';

    let left = centers[i] - bw / 2;
    left = Math.max(56, Math.min(left, w - 56 - bw));

    el.style.left   = left + 'px';
    el.style.bottom = '0px';
  });
}
  window.addEventListener('resize', positionBaskets);

  let unlocked=false;
  const bgm = document.getElementById('bgm');

  function firstGestureUnlock(){
    if(unlocked) return;
    unlocked=true;
    AudioBus.unlock();
    try{
      if(bgm){
        bgm.volume = 0.4;
        bgm.currentTime = 0;
        bgm.play().catch(()=>{});
      }
    }catch(e){}
    overlayStart.classList.add('hidden');
    state.roundActive=true;
    startRound();
  }

  overlayStart.addEventListener('click', firstGestureUnlock);
  controlsEl.addEventListener('click', firstGestureUnlock);
  document.addEventListener('keydown', firstGestureUnlock, { once:false });

  function evaluateClick(ans){handleChoice(ans)}

  controlsEl.addEventListener('click',(e)=>{
    const btn=e.target.closest('[data-answer]');
    if(!btn) return;
    if(!state.roundActive) return;
    evaluateClick(btn.dataset.answer);
  });

  document.addEventListener('keydown',(e)=>{
    if(!state.roundActive) return;
    const k=e.key.toLowerCase();
    if(LEVELS[state.level].mode==='three'){
      if(k==='t') evaluateClick('thought');
      else if(k==='f') evaluateClick('feeling');
      else if(k==='a') evaluateClick('action');
    }else{
      if(k==='+'||k==='=' ) evaluateClick('positive');
      else if(k==='-') evaluateClick('negative');
    }
  });

  document.getElementById('btnAgain').addEventListener('click',()=>{
    results.classList.add('hidden');
    hudEl.classList.remove('hidden');
    controlsEl.classList.remove('hidden');
    resetState(true);
    startRound();
  });

  document.getElementById('btnNext').addEventListener('click',()=>{
    if(state.level<5){ state.level+=1; }
    results.classList.add('hidden');
    hudEl.classList.remove('hidden');
    controlsEl.classList.remove('hidden');
    state.showMimiIntroThisRound = true;
    prepareLevel();
    resetState(true);
    startRound();
  });

  function resetState(clearLog){
    clearTimers();
    state.score=0;scoreEl.textContent='Score: 0';
    timerEl.textContent='30.0';
    state.roundActive=false;state.current=null;state.freezeInput=false;
    state.started=false;
    if(clearLog){state.log={thought:[],feeling:[],action:[],positive:[],negative:[]}}
    layer.innerHTML='';
    state.streak=0;
    state.wrongRun=0;
    state.mimiShownThisPlay=false;
    hideMimi();
    state.roundClockStarted=false;
    state.roundClockDelayUntil=0;
  }

  function prepareLevel(){
    applyLevelHeader();
    applyLevelControls();
    renderBasketsForLevel();
  }

  function startRound(){
    state.started=true;
    state.roundActive=true;
    results.classList.add('hidden');
    prepareLevel();
    if (state.showMimiIntroThisRound && state.level >= 2) {
      let msg = '';
      if (state.level === 2) { msg = 'Click ‚Äú+‚Äù for a nice experience ‚Äì Click ‚Äú‚Äì‚Äù for a not nice experience'; }
      else if (state.level === 3) { msg = 'Click ‚Äú+‚Äù for a nice feeling ‚Äì Click ‚Äú‚Äì‚Äù for a not nice feeling'; }
      else if (state.level === 4) { msg = 'Click ‚Äú+‚Äù for a nice thought ‚Äì Click ‚Äú‚Äì‚Äù for a not nice thought'; }
      else if (state.level === 5) { msg = 'Click ‚Äú+‚Äù for a kind action ‚Äì Click ‚Äú‚Äì‚Äù for an unkind action'; }
      if (msg) { showMimiInstruction(msg); }
      state.roundClockDelayUntil = performance.now() + 4000;
      state.showMimiIntroThisRound = false;
    } else {
      state.roundClockDelayUntil = 0;
    }
    state.roundClockStarted=false;
    state.deck = buildDeckForLevel(state.level);
    state.wrongRun=0;
    state.mimiShownThisPlay=false;
    spawnNext(true);
  }

  function startRoundClock(){
    if(state.roundClockStarted) return;
    state.roundClockStarted=true;
    const start=performance.now();
    const endAt=start+state.roundMs;
    const tick=()=>{
      const now=performance.now();
      const left=Math.max(0,endAt-now);
      timerEl.textContent=(left/1000).toFixed(1);
      if(left<=0){roundTimeout();return}else{state.timers.raf=requestAnimationFrame(tick)}
    };
    state.timers.raf=requestAnimationFrame(tick);
    state.timers.round=setTimeout(roundTimeout,state.roundMs);
  }

  function maybeStartRoundClock(){
    if(state.roundClockStarted) return;
    const wait = state.roundClockDelayUntil ? Math.max(0, state.roundClockDelayUntil - performance.now()) : 0;
    if(wait>0){
      if(state.timers.roundDelay) clearTimeout(state.timers.roundDelay);
      state.timers.roundDelay = setTimeout(()=>{ startRoundClock(); }, wait);
    }else{
      startRoundClock();
    }
  }

  function roundTimeout(){
    popActive();
    endRound();
  }

  function endRound(){
    clearTimers();
    state.roundActive=false;
    hideMimi();
    finalScore.textContent=state.score;
    const L=LEVELS[state.level];
    if(L.mode==='three'){
      ['thought','feeling','action'].forEach(k=>{
        const ul=tallyEls[k]; ul.innerHTML='';
        state.log[k].slice(-6).forEach(t=>{const li=document.createElement('li'); li.textContent=t; ul.appendChild(li)});
      });
    }else{
      tallyEls.thought.innerHTML='';
      tallyEls.feeling.innerHTML='';
      tallyEls.action.innerHTML='';
      state.log.positive.slice(-6).forEach(t=>{const li=document.createElement('li'); li.textContent=t; tallyEls.thought.appendChild(li)});
      state.log.negative.slice(-6).forEach(t=>{const li=document.createElement('li'); li.textContent=t; tallyEls.feeling.appendChild(li)});
    }
    if (L.mode === 'three') {
      tallyHeads[0].textContent = 'Thoughts';
      tallyHeads[1].textContent = 'Feeling';
      tallyHeads[2].textContent = 'Actions';
      tallyCols[2].style.display = '';
      tallyContainer.style.gridTemplateColumns = 'repeat(3,1fr)';
    } else {
      let h1 = 'Nice experience', h2 = 'Not nice experience';
      if (state.level === 3) { h1 = 'Nice feeling'; h2 = 'Not nice feeling'; }
      else if (state.level === 4) { h1 = 'Nice thought'; h2 = 'Not nice thought'; }
      else if (state.level === 5) { h1 = 'Kind action'; h2 = 'Unkind action'; }
      tallyHeads[0].textContent = h1;
      tallyHeads[1].textContent = h2;
      tallyHeads[2].textContent = '';
      tallyCols[2].style.display = 'none';
      tallyContainer.style.gridTemplateColumns = 'repeat(2,1fr)';
    }
    results.classList.remove('hidden');
    hudEl.classList.add('hidden');
    controlsEl.classList.add('hidden');
    const b=document.getElementById('burst'); b.style.opacity='0'; void b.offsetWidth; b.style.opacity='1';
    AudioBus.play('fanfare');
    document.getElementById('btnNext').style.display=(state.level<5)?'inline-block':'none';
  }

  function clearTimers(){
    ['fall','spawn','round'].forEach(k=>{if(state.timers[k]){clearTimeout(state.timers[k]);state.timers[k]=null}});
    if(state.timers.raf){cancelAnimationFrame(state.timers.raf);state.timers.raf=null}
    if(state.timers.roundDelay){clearTimeout(state.timers.roundDelay);state.timers.roundDelay=null}
  }

  function buildDeckForLevel(level){
    const L = LEVELS[level];
    if (L.id === 1){
      const cats = ['thought','feeling','action'];
      const pools = {
        thought: stimuliL1.filter(s=>s.category==='thought'),
        feeling: stimuliL1.filter(s=>s.category==='feeling'),
        action:  stimuliL1.filter(s=>s.category==='action')
      };
      let bag = shuffle(cats.slice());
      const history = [];
      return {
        next(){
          let choice = null, tries = 0;
          while(!choice && tries < 6){
            if (bag.length === 0) bag = shuffle(cats.slice());
            for (let i=0;i<bag.length;i++){
              const cand = bag[i];
              const h = history.slice(-2);
              if (!(h[0]===cand && h[1]===cand)){
                choice = cand;
                bag.splice(i,1);
                break;
              }
            }
            if (!choice){ bag = shuffle(cats.slice()); tries++; }
          }
          if (!choice) choice = cats[Math.floor(Math.random()*cats.length)];
          history.push(choice);
          const arr = pools[choice];
          return arr[Math.floor(Math.random()*arr.length)];
        }
      };
    } else {
      const arrays = { 2: stimuliL2, 3: stimuliL3, 4: stimuliL4, 5: stimuliL5 }[L.id];
      const pools = {
        positive: arrays.filter(s=>s.valence==='positive'),
        negative: arrays.filter(s=>s.valence==='negative')
      };
      const history = [];
      const counts  = { positive:0, negative:0 };
      return {
        next(){
          const h = history.slice(-2);
          let target = null;
          if (h[0] && h[1] && h[0]===h[1]) {
            target = (h[0] === 'positive') ? 'negative' : 'positive';
          } else {
            if (counts.positive < counts.negative) target = 'positive';
            else if (counts.negative < counts.positive) target = 'negative';
            else target = (Math.random()<0.5) ? 'positive' : 'negative';
          }
          const arr = pools[target];
          const pick = arr[Math.floor(Math.random()*arr.length)];
          history.push(target);
          counts[target] += 1;
          return pick;
        }
      };
    }
  }

  function nextStimulus(){
    if (!state.deck) state.deck = buildDeckForLevel(state.level);
    return state.deck.next();
  }

  function pickStimulusForLevel(){
    return nextStimulus();
  }

  function spawnNext(initial){
    if(!state.roundActive) return;
    const pick=pickStimulusForLevel();
    const fall=fallMsFor(pick.text);
    const node=makeBalloon(pick.text);
    const obj={id:pick.id,category:pick.category,text:pick.text,fallMs:fall,tries:0,el:node,valence:pick.valence||null,locked:false};
    state.current=obj;
    layer.appendChild(node);
    inflateThenFall(node,fall,()=>missPop(),initial===true);
  }

  function interGapThenSpawn(){state.timers.spawn=setTimeout(()=>spawnNext(false),200)}

  function inflateThenFall(node,fallMs,onMiss,isInitial){
    node.style.transition='transform 300ms ease, opacity 300ms ease';
    node.style.transform='translateY(-80px) scale(1)'; node.style.opacity='1';
    setTimeout(()=>{
      node.style.transition=`transform ${fallMs}ms linear`;
      const playRect = play.getBoundingClientRect();
      const travel   = playRect.height + 80;
      if(isInitial){ maybeStartRoundClock(); }
      node.style.transform=`translateY(${travel}px) scale(1)`;
      state.timers.fall=setTimeout(()=>onMiss(),fallMs);
    },300);
  }

  function popActive(){
    const cur=state.current; if(!cur||!cur.el) return;
    try{cur.el.remove()}catch(e){};
    state.current=null;
    AudioBus.play('pop');
  }

  function missPop(){
    if(!state.roundActive) return;
    popActive();
    state.streak=0;
    state.wrongRun+=1;
    checkMimiTrigger();
    interGapThenSpawn();
  }

  function makeBalloon(text){
    const div=document.createElement('div'); div.className='balloon';
    div.innerHTML=`<svg viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <defs><radialGradient id="g" cx="30%" cy="25%" r="60%"><stop offset="0%" stop-color="#ffffff" stop-opacity="0.9"/><stop offset="40%" stop-color="#ffffff" stop-opacity="0.2"/><stop offset="100%" stop-color="#ffffff" stop-opacity="0"/></radialGradient></defs>
    <ellipse cx="250" cy="220" rx="185" ry="185" fill="#FFB6C1" stroke="#000" stroke-width="2"/>
    <path d="M245 410 L255 410 L260 455 Q250 470 240 455 Z" fill="#e88aa2" stroke="#000" stroke-width="2"/>
    <ellipse cx="200" cy="140" rx="70" ry="50" fill="url(#g)"/>
  </svg>`;
    const txt=document.createElement('div'); txt.className='txt'; txt.setAttribute('aria-live','polite');
    const span=document.createElement('span'); span.textContent=text; txt.appendChild(span);
(function(el){
const cs=getComputedStyle(el);
let base=parseFloat(cs.fontSize)||24;
let target=base+2;
el.style.fontSize=target+'px';
const container=el.parentElement;
let tries=0;
while(tries<6&&(el.scrollWidth>container.clientWidth||el.scrollHeight>container.clientHeight)){
  target-=1;
  if(target<base) break;
  el.style.fontSize=target+'px';
  tries++;
}
if((el.scrollWidth>container.clientWidth||el.scrollHeight>container.clientHeight)){
  el.style.lineHeight='1.2';
}
})(span); div.appendChild(txt);
    const s=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--balloonScale'))||0.42;
    autoFit(span, Math.round(360*s), Math.round(220*s), Math.round(32*s));
    return div;
  }

  function autoFit(el,maxW,maxH,base){
    let size=base;
    el.style.fontWeight='800';
    el.style.whiteSpace='normal';
    el.style.wordBreak='break-word';
    el.style.hyphens='auto';
    el.style.fontSize=size+'px';
    while(size>10 && (el.scrollWidth>maxW || el.scrollHeight>maxH)){
      size-=1;
      el.style.fontSize=size+'px';
    }
  }

  function getBasketEl(type){return document.querySelector('.basket[data-type="'+type+'"]')}
  function basketRect(type){
    const el=getBasketEl(type);
    const r=el.getBoundingClientRect();
    const p=play.getBoundingClientRect();
    return { left:r.left-p.left, top:r.top-p.top, width:r.width, height:r.height, cx:(r.left-p.left)+r.width/2, cy:(r.top-p.top)+r.height/2 };
  }
  function normalizeNodeToPlaySpace(node){
    const pRect=play.getBoundingClientRect();
    const r=node.getBoundingClientRect();
    node.style.transition='none';
    node.style.left=(r.left - pRect.left)+'px';
    node.style.top =(r.top  - pRect.top )+'px';
    node.style.transform='translate3d(0,0,0)';
  }
  function glideToBasket(node, type, done){
    normalizeNodeToPlaySpace(node);
    const from=node.getBoundingClientRect();
    const pRect=play.getBoundingClientRect();
    const curX=from.left - pRect.left, curY=from.top - pRect.top;
    const bw=from.width, bh=from.height;
    const b=basketRect(type);
    const targetX = b.cx - bw/2;
    const targetY = b.top + (b.height - bh*0.65);
    const dx=targetX - curX, dy=targetY - curY, dur=300;
    const ease=t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1;
    const t0=performance.now();
    (function step(now){
      let t=(now-t0)/dur; if(t>1)t=1;
      const e=ease(t);
      node.style.transform=`translate3d(${dx*e}px, ${dy*e}px, 0)`;
      if(t<1){ requestAnimationFrame(step); } else { node.remove(); done&&done(); }
    })(performance.now());
  }

  function emojiBurst(type){
    const el=document.createElement('div'); el.className='emoji-burst';
    const b=basketRect(type);
    el.style.left=(b.cx - 10)+'px'; el.style.top=(b.top + 10)+'px';
    const map={thought:'üí≠',feeling:'‚ù§Ô∏è',action:'üë£',positive:'‚ú®',negative:'üí•'};
    el.textContent=(map[type]||'‚ú®')+' ‚ú®';
    play.appendChild(el);
    setTimeout(()=>{try{el.remove()}catch(e){}},260);
  }

  const AudioBus=(()=>{
    let ctx=null,enabled=false; const cache={};
    function unlock(){ if(enabled) return; try{ctx=new (window.AudioContext||window.webkitAudioContext)(); enabled=true}catch(e){enabled=false} }
    function loadTag(path){return new Promise(resolve=>{const a=new Audio(); a.preload='auto'; a.src=path; a.oncanplay=()=>resolve(a); a.onerror=()=>resolve(null)});}
    async function play(name){
      if(!enabled){return}
      const tryList=({correct:[SFX+'correct.mp3',SFX+'correct.ogg'],wrong:[SFX+'wrong.mp3',SFX+'wrong.ogg'],pop:[SFX+'pop.mp3',SFX+'pop.ogg'],fanfare:[SFX+'fanfare.mp3',SFX+'fanfare.ogg']})[name]||[];
      for(const p of tryList){
        try{
          let tag=cache[p];
          if(tag===undefined){tag=await loadTag(p); cache[p]=tag}
          if(tag){tag.currentTime=0; await tag.play(); return}
        }catch(e){}
      }
      synth(name);
    }
    function synth(name){
      if(!ctx) return;
      const o=ctx.createOscillator(); const g=ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      let f=440; if(name==='correct')f=660; if(name==='wrong')f=220; if(name==='pop')f=120; if(name==='fanfare')f=523;
      o.frequency.setValueAtTime(f,ctx.currentTime);
      g.gain.setValueAtTime(0,ctx.currentTime);
      g.gain.linearRampToValueAtTime(0.2,ctx.currentTime+0.005);
      let dur=0.15; if(name==='correct')dur=0.18; if(name==='wrong')dur=0.12; if(name==='pop')dur=0.08; if(name==='fanfare')dur=0.4;
      g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+dur);
      o.start(); o.stop(ctx.currentTime+dur);
    }
    return {unlock,play};
  })();

  function handleChoice(choice){
    if(!state.roundActive||state.freezeInput) return;
    const cur=state.current; if(!cur||!cur.el) return;
    const L=LEVELS[state.level];
    const correct=(L.mode==='three') ? (choice===cur.category) : (choice===cur.valence);
    cur.tries=(cur.tries||0)+1;
    if(!L.allowSecond){ cur.locked=true; }
    if(correct){
      state.wrongRun=0;
      state.freezeInput=true;
      if(L.streak){
        const pre=state.streak;
        state.streak = pre+1;
        let bonus=0; if(pre===1) bonus=10; else if(pre>=2) bonus=15;
        const add = Math.min(20, 5 + bonus);
        state.score+=add;
      }else{
        state.score+=5;
      }
      scoreEl.textContent='Score: '+state.score;
      AudioBus.play('correct');
      if(state.timers.fall){clearTimeout(state.timers.fall);state.timers.fall=null}
      const logKey=(L.mode==='three')?cur.category:cur.valence;
      glideToBasket(cur.el,(L.mode==='three')?cur.category:cur.valence,()=>{
        state.log[logKey].push(cur.text);
        state.freezeInput=false; state.current=null;
        interGapThenSpawn();
        emojiBurst((L.mode==='three')?cur.category:cur.valence);
      });
    }else{
      AudioBus.play('wrong');
      if(L.streak){ state.streak=0; }
      state.wrongRun+=1;
      checkMimiTrigger();
      if(!L.allowSecond || cur.tries>=2){
        cur.locked=true;
      }
    }
  }

  function checkMimiTrigger(){
    if(state.wrongRun===3 && !state.mimiShownThisPlay){
      state.mimiShownThisPlay=true;
      showMimi();
    }
  }

  function showMimi(){
    const rootId='mimi-nudge';
    let root=document.getElementById(rootId);
    if(!root){
      root=document.createElement('div');
      root.id=rootId;
      play.appendChild(root);
    }
    root.innerHTML='';
    const avatar=document.createElement('div');
    avatar.className='mimi-avatar';
    const img=document.createElement('img');
    img.alt='Mimi';
    img.onerror=()=>{img.remove(); avatar.classList.add('fallback'); avatar.textContent='Mimi';};
    img.src='./assets/quiz-balloon/images/mimi.gif';
    avatar.appendChild(img);
    const bubble=document.createElement('div');
    bubble.className='mimi-bubble';
    if(state.level===1){ bubble.classList.add('compact'); }
    bubble.innerHTML=getMimiMessageHTML(state.level);
    root.appendChild(avatar);
    root.appendChild(bubble);
    state.mimiShownAt=performance.now();
    if(state.mimiTimer){clearTimeout(state.mimiTimer);}
    state.mimiTimer=setTimeout(()=>{hideMimi();},5000);
  }

  function hideMimi(){
    const min=5000;
    const elapsed=performance.now()-state.mimiShownAt;
    if(elapsed<min){
      if(state.mimiTimer){clearTimeout(state.mimiTimer);}
      state.mimiTimer=setTimeout(hideMimi, min - elapsed);
      return;
    }
    if(state.mimiTimer){clearTimeout(state.mimiTimer); state.mimiTimer=null;}
    const n=document.getElementById('mimi-nudge');
    if(n){try{n.remove();}catch(e){}}
  }

  function getMimiMessageHTML(level){
    if(level===1){
      return 'Do you remember?<br><br>Thoughts are the words you say in your head<br><br>Actions are what you do<br><br>Feelings are how you feel inside.<br>Don‚Äôt worry, you‚Äôll get it!';
    }else if(level===2){
      return 'Do you remember?<br><br>Experiences are things that happen to you: some are nice and some are not nice<br>Don‚Äôt worry, you‚Äôll get it!';
    }else if(level===3){
      return 'Do you remember?<br><br>Feelings are things that you feel inside: some are nice and some are not nice<br>Don‚Äôt worry, you‚Äôll get it!';
    }else if(level===4){
      return 'Do you remember?<br><br>Thoughts are the words you say in your head: some are nice and some are not nice<br>Don‚Äôt worry, you‚Äôll get it!';
    }else{
      return 'Do you remember?<br><br>Actions are things you do: some are kind and some are unkind<br>Don‚Äôt worry, you‚Äôll get it!';
    }
  }

  function showMimiInstruction(text){
  const rootId='mimi-instruction';
  let root=document.getElementById(rootId);
  if(!root){
    root=document.createElement('div');
    root.id=rootId;
    root.style.position='absolute';
    root.style.top='12px';
    root.style.right='12px';
    root.style.zIndex='4';
    root.style.pointerEvents='none';
    play.appendChild(root);
  }
  root.innerHTML='';
  const avatar=document.createElement('div');
  avatar.className='mimi-avatar';
  const img=document.createElement('img');
  img.alt='Mimi';
  img.onerror=()=>{img.remove(); avatar.classList.add('fallback'); avatar.textContent='Mimi';};
  img.src='./assets/quiz-balloon/images/mimi.gif';
  avatar.appendChild(img);

  const bubble=document.createElement('div');
  bubble.className='mimi-bubble';
  bubble.style.pointerEvents='none';
  bubble.innerHTML = text;

  root.appendChild(avatar);
  root.appendChild(bubble);

  setTimeout(()=>{ try{ root.remove(); }catch(e){} }, 4000);
}

  window.addEventListener('load',init);
  function init(){
    ensureControls();
    applyLevelControls();
    prepareLevel();
    resetState(true);
    if(bgm){ try{ bgm.volume = 0.4; }catch(e){} }
  }
</script>
</body>
</html>