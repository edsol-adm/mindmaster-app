<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MindMaster — What’s Missing?</title>
  <style>
    :root{ --pink:#FFB6C1; --yellow:#FFD700; --gap:12px; }
    html,body{ height:100%; }
    body{ font-family:'Comic Neue', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--pink); margin:0; padding:0; display:flex; flex-direction:column; align-items:center; min-height:100vh; color:#111; }
    h1{ margin:24px 0 6px; font-size:2.2rem; }
    .sub{ margin:0 0 12px; font-size:1.1rem; }
    .hidden{ display:none !important; }
    .controls{ margin:10px 0; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    button{ background:var(--yellow); color:#000; padding:10px 18px; border:none; border-radius:12px; font-size:1rem; cursor:pointer; }
    button:focus{ outline:3px solid #000; outline-offset:2px; }
    .feedback{ min-height:1.6rem; margin:8px 0 10px; font-size:1.2rem; text-align:center; }
    .game-wrap{ width:min(640px, 92vw); display:flex; flex-direction:column; align-items:center; }
    .board{ display:grid; grid-template-columns:repeat(3, 1fr); gap:var(--gap); width:100%; }
    .cell{ aspect-ratio:1/1; border-radius:12px; overflow:hidden; position:relative; background:#fff8; display:flex; align-items:center; justify-content:center; }
    .cell img{ width:100%; height:100%; object-fit:contain; }
    .question-tile{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#ffd9e6; border:3px dashed #e567a3; color:#e01967; font-weight:800; font-size:2.6rem; border-radius:12px; }
    .choices{ display:flex; flex-wrap:wrap; justify-content:center; gap:12px; width:100%; margin-top:12px; }
    .choice-btn{ display:flex; align-items:center; justify-content:center; gap:8px; background:var(--yellow); border:none; border-radius:12px; padding:8px; cursor:pointer; min-width:96px; max-width:140px; flex:1 1 100px; }
    .choice-btn:focus{ outline:3px solid #000; outline-offset:2px; }
    .choice-btn img{ width:64px; height:64px; object-fit:contain; }
    .pulse{ animation:pulse 550ms ease; } @keyframes pulse{ 0%{transform:scale(1)} 50%{transform:scale(1.08)} 100%{transform:scale(1)} }
    .wobble{ animation:wobble 450ms ease; } @keyframes wobble{ 0%{transform:translateX(0)} 20%{transform:translateX(-6px)} 40%{transform:translateX(6px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(3px)} 100%{transform:translateX(0)} }
    .timer-rail{ width:100%; height:8px; background:#fff7; border-radius:999px; overflow:hidden; margin:6px 0 10px; }
    .timer-bar{ height:100%; width:0; background:#e01967; }
    #end{text-align:center; margin-top:16px;}
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    /* Launch background slot (intro screen only) */
    #instructions{ position:relative; overflow:hidden; }
    #instructions .launch-bg{
      position:absolute; inset:0;
      background-image:url('assets/memory2/images/ui/bg-launch.png');
      background-size:cover; background-position:center; background-repeat:no-repeat;
      z-index:0;
    }
    #instructions > *:not(.launch-bg){ position:relative; z-index:1; }
    .unit-overline{
      margin-top:12px;
      padding:4px 10px; display:inline-block;
      border-radius:999px; background:#f5c242; color:#111;
      font-size:0.95rem; font-weight:700; letter-spacing:0.2px;
    }

  
/* === Launch screen: full-viewport background & intro card (mirror shadow-match) === */
#instructions{
  position: fixed; inset: 0;
  display: flex; align-items: center; justify-content: center;
  width: 100vw; height: 100vh;
  padding: 16px;
}
#instructions::before{
  content: ""; position: absolute; inset: 0;
  background: url('assets/memory2/images/ui/bg-launch.png') center/cover no-repeat;
  z-index: 0;
}
#instructions > *{ position: relative; z-index: 1; }

/* Hide legacy background layer */
#instructions .launch-bg{ display:none !important; }

/* Intro card */
.intro-card{
  width: min(720px, 92vw);
  background: rgba(255,253,253,0.85);
  border-radius: 18px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.20);
  padding: 20px 18px 18px;
  text-align: center;
}

/* Unit pill colour update */
.unit-overline{
  margin-top: 12px;
  padding: 6px 12px;
  display: inline-block;
  border-radius: 999px;
  background: #f5c242;  /* updated to requested colour */
  color: #111;
  font-size: 0.95rem;
  font-weight: 800;
  letter-spacing: 0.2px;
  border: 1px solid rgba(0,0,0,0.08);
}

/* Button colours to mirror shadow-match */
#startBtn{ background:#90EE90; }
#howToBtn{ background:#FFD700; }
#homeBtn{  background:#87CEFA; }
#playAgainBtn{ background:#FFD700; } /* end screen styling parity */
#homeBtn2{ background:#87CEFA; }

  </style>
</head>
<body><!-- Intro / Instructions (Storytime-style: Start, How to play, Home) -->
  <section id="instructions" class="game-wrap">
        <div class="intro-card">
<div class="unit-overline" role="text">Unit 4: How Memory Works</div>
    <h1>What’s Missing?</h1>
    <div class="launch-bg" aria-hidden="true"></div>

    <p class="sub">Look at the 6 pictures. One will disappear! Can you remember which?</p>
    <div class="controls">
      <button id="startBtn">Start</button>
      <button id="howToBtn">How to play</button>
      <button id="homeBtn">Return to the Park</button>
    </div>
    <div id="howToPanel" class="hidden" aria-live="polite" style="background:#fff8;padding:12px;border-radius:12px;">
      <ul style="margin:8px 0 0 18px;">
        <li>Study the 6 pictures carefully.</li>
        <li>One picture will vanish after a short time.</li>
        <li>Choose the missing picture from the options below.</li>
        <li>Get it right to move to the next round.</li>
        <li>Finish all 5 rounds to see your score and stars.</li>
      </ul>
    </div>
    </div>
  </section>

  <!-- Game View -->
  <section id="game" class="game-wrap hidden">
    <p id="feedback" class="feedback" aria-live="polite"></p>
    <div class="timer-rail" aria-hidden="true"><div id="timerBar" class="timer-bar"></div></div>
    <div id="board" class="board" role="grid" aria-label="Study grid"></div>
    <div id="choices" class="choices hidden" role="group" aria-label="Choices"></div>
  </section>

  <!-- End Screen with stars/score -->
  <section id="end" class="hidden game-wrap">
    <h2 id="endHeadline">You remembered them all!</h2>
    <p id="endScore">You’ve got 0 out of 5 scores!</p>
    <div id="starRow" class="controls" aria-label="Star rating" style="gap:8px;"></div>
    <div class="controls">
      <button id="playAgainBtn">Play Again</button>
      <button id="homeBtn2">Return to the Park</button>
    </div>
  </section>

  <!-- Audio -->
  <audio id="bgm" src="assets/memory2/audio/bgm.mp3" loop></audio>
  <audio id="sfxCorrect" src="assets/memory2/sfx/correct.mp3"></audio>
  <audio id="sfxWrong"   src="assets/memory2/sfx/wrong.mp3"></audio>
  <audio id="resultsChime" src="assets/memory2/sfx/results-chime.mp3"></audio>
  <!-- Voice lines -->
  <audio id="v_great_job" src="assets/memory2/voice/great_job.mp3"></audio>
  <audio id="v_you_got_it" src="assets/memory2/voice/you_got_it.mp3"></audio>
  <audio id="v_well_spotted" src="assets/memory2/voice/well_spotted.mp3"></audio>
  <audio id="v_awesome_work" src="assets/memory2/voice/awesome_work.mp3"></audio>
  <audio id="v_try_again" src="assets/memory2/voice/try_again.mp3"></audio>
  <audio id="v_check_carefully" src="assets/memory2/voice/check_carefully.mp3"></audio>
  <audio id="v_you_did_it" src="assets/memory2/voice/you_did_it.mp3"></audio>
  <audio id="v_great_memory_today" src="assets/memory2/voice/great_memory_today.mp3"></audio>

  <script>
    // ===============================
    // Memory 2 (What’s Missing?) – Prompt 4 updates
    // ===============================

    function smartImg(srcBase, className, alt){
      const img = document.createElement('img');
      img.className = className || '';
      img.alt = alt || '';
      img.src = srcBase.endsWith('.png') || srcBase.endsWith('.jpg') ? srcBase : (srcBase + '.png');
      img.onerror = () => { img.onerror = null; img.src = srcBase; };
      return img;
    }

    // Elements
    const instructionsEl = document.getElementById('instructions');
    const gameEl         = document.getElementById('game');
    const endEl          = document.getElementById('end');

    const startBtn       = document.getElementById('startBtn');
    const howToBtn       = document.getElementById('howToBtn');
    const howToPanel     = document.getElementById('howToPanel');
    const homeBtn        = document.getElementById('homeBtn');
    const homeBtn2       = document.getElementById('homeBtn2');
    const playAgainBtn   = document.getElementById('playAgainBtn');

    const feedbackEl     = document.getElementById('feedback');
    const boardEl        = document.getElementById('board');
    const choicesEl      = document.getElementById('choices');
    const timerBarEl     = document.getElementById('timerBar');

    const endHeadlineEl  = document.getElementById('endHeadline');
    const endScoreEl     = document.getElementById('endScore');
    const starRowEl      = document.getElementById('starRow');

    const bgm            = document.getElementById('bgm');
    const sfxCorrect     = document.getElementById('sfxCorrect');
    const sfxWrong       = document.getElementById('sfxWrong');
    const resultsChime   = document.getElementById('resultsChime');

    const voicesPos = [
      document.getElementById('v_great_job'),
      document.getElementById('v_you_got_it'),
      document.getElementById('v_well_spotted'),
      document.getElementById('v_awesome_work'),
      document.getElementById('v_you_did_it'),
    ];
    const voicesTry = [ document.getElementById('v_try_again'), document.getElementById('v_check_carefully') ];
    const voiceEndA = document.getElementById('v_great_memory_today');
    const voiceEndB = document.getElementById('v_you_did_it');

    // Config
    const STUDY_MS = 9000;   // ~9s (age-appropriate 8–10s)
    const HIDE_MS  = 500;    // 0.5s
    const ROUNDS   = 5;      // 5 rounds total

    // Session scoring
    let sessionFirstTryCount = 0;

    // Media inventory
    const IMG_BASE = 'assets/memory2/images/';
    const CATEGORIES = {
      animals: [ 'animals/cat.png','animals/dog.png','animals/cow.png','animals/horse.png','animals/sheep.png','animals/elephant.png','animals/duck.png','animals/tiger.png','animals/bird.png','animals/lion.png' ],
      objects: [ 'objects/ball.png','objects/car.png','objects/chair.png','objects/book.png','objects/clock.png','objects/cup.png','objects/key.png','objects/shoes.png','objects/tree.png','objects/house.png' ],
      emotions:[ 'emotions/happy.png','emotions/sad.png','emotions/angry.png','emotions/surprised.png','emotions/scared.png','emotions/tired.png','emotions/proud.png','emotions/calm.png' ]
    };
    const ALL_ITEMS = [...CATEGORIES.animals, ...CATEGORIES.objects, ...CATEGORIES.emotions];

    // LocalStorage metrics
    const NS = 'memory2/';
    const METRIC_KEYS = {
      roundsPlayed: NS+'roundsPlayed',
      correctFirst: NS+'correctFirstTry',
      avgMs:       NS+'avgResponseMs',
      lastUsed:    NS+'lastUsedSetIds'
    };
    function lsGet(key, def){ try{ const v = localStorage.getItem(key); return v==null? def : JSON.parse(v); }catch{ return def; } }
    function lsSet(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch{} }
    if(localStorage.getItem(METRIC_KEYS.roundsPlayed)===null) lsSet(METRIC_KEYS.roundsPlayed, 0);
    if(localStorage.getItem(METRIC_KEYS.correctFirst)===null) lsSet(METRIC_KEYS.correctFirst, 0);
    if(localStorage.getItem(METRIC_KEYS.avgMs)===null) lsSet(METRIC_KEYS.avgMs, 0);
    if(localStorage.getItem(METRIC_KEYS.lastUsed)===null) lsSet(METRIC_KEYS.lastUsed, []);

    // State
    let roundIndex = 0;
    let hiddenSrc = null;     // correct answer path
    let categoryKey = null;   // 'animals' | 'objects' | 'emotions' | 'mixed'
    let gridSet = [];         // 6 images this round
    let firstPick = true;     // track first-try
    let studyStartMs = 0;     // response timing
    let phase = 'intro';

    // Helpers
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
    function sample(arr, n){ const copy=[...arr]; shuffle(copy); return copy.slice(0, n); }
    function avoidRecent(items){ const recent = new Set(lsGet(METRIC_KEYS.lastUsed, [])); const fresh = items.filter(x=>!recent.has(x)); return fresh.length>=6 ? fresh : items; }
    function pushRecent(used){ const recent = lsGet(METRIC_KEYS.lastUsed, []); const merged = [...used, ...recent]; const trimmed = Array.from(new Set(merged)).slice(0, 36); lsSet(METRIC_KEYS.lastUsed, trimmed); }
    function preloadImages(srcs){ srcs.forEach(src=>{ const i=new Image(); i.src = IMG_BASE + src; }); }
    function playSafe(audio){ try{ audio.currentTime=0; audio.play().catch(()=>{}); }catch{} }

    // Category logic: R1–R3 single-category, R4–R5 mixed
    function chooseCategory(){ if (roundIndex <= 2){ const order = ['animals','objects','emotions']; return order[roundIndex % order.length]; } return 'mixed'; }

    // Rendering
    function renderBoard(showQuestionTile){
      const boardElLocal = boardEl; boardElLocal.innerHTML=''; boardElLocal.setAttribute('aria-busy','true');
      gridSet.forEach(src => { const cell=document.createElement('div'); cell.className='cell'; cell.role='gridcell'; if(showQuestionTile && src===hiddenSrc){ const q=document.createElement('div'); q.className='question-tile'; q.textContent='?'; cell.appendChild(q); } else { cell.appendChild(smartImg(IMG_BASE+src,'','study image')); } boardElLocal.appendChild(cell); });
      boardElLocal.removeAttribute('aria-busy');
    }
    function renderChoices(options){
      choicesEl.innerHTML='';
      options.forEach(src=>{ const btn=document.createElement('button'); btn.className='choice-btn'; btn.dataset.src=src; btn.setAttribute('aria-label', src.split('/').pop().replace(/\.png|\.jpg/i,'').replace(/[-_]/g,' ')); btn.appendChild(smartImg(IMG_BASE+src,'','choice')); btn.addEventListener('click', onChoiceClick); choicesEl.appendChild(btn); });
      const btns=[...choicesEl.querySelectorAll('.choice-btn')];
      btns.forEach((b,i)=>{ b.addEventListener('keydown', (e)=>{ if(e.key==='ArrowRight'){ e.preventDefault(); btns[(i+1)%btns.length].focus(); } else if(e.key==='ArrowLeft'){ e.preventDefault(); btns[(i-1+btns.length)%btns.length].focus(); } else if(e.key==='Enter' || e.key===' '){ e.preventDefault(); b.click(); } }); });
    }

    // Phases
    function goIntro(){ phase='intro'; instructionsEl.classList.remove('hidden'); gameEl.classList.add('hidden'); endEl.classList.add('hidden'); }

    function goStudy(){
      phase='study'; instructionsEl.classList.add('hidden'); endEl.classList.add('hidden'); gameEl.classList.remove('hidden'); choicesEl.classList.add('hidden'); feedbackEl.textContent='Ready… study carefully!'; firstPick=true;
      categoryKey = chooseCategory();
      let pool = categoryKey==='mixed' ? avoidRecent(ALL_ITEMS) : avoidRecent(CATEGORIES[categoryKey]);
      gridSet = sample(pool, 6);
      hiddenSrc = gridSet[Math.floor(Math.random()*gridSet.length)];
      const extraPool = categoryKey==='mixed' ? ALL_ITEMS : CATEGORIES[categoryKey];
      const preloadSet = new Set([...gridSet, ...sample(extraPool.filter(x=>!gridSet.includes(x)), 6)]);
      preloadImages([...preloadSet]);
      renderBoard(false);
      timerBarEl.style.transition='none'; timerBarEl.style.width='0%'; requestAnimationFrame(()=>{ timerBarEl.style.transition=`width ${STUDY_MS}ms linear`; timerBarEl.style.width='100%'; });
      bgm.volume=0.35; bgm.play().catch(()=>{});
      studyStartMs = performance.now();
      setTimeout(goHide, STUDY_MS);
    }

    function goHide(){ phase='hide'; feedbackEl.textContent='Get ready…'; boardEl.innerHTML=''; for(let i=0;i<6;i++){ const cell=document.createElement('div'); cell.className='cell'; const cover=document.createElement('div'); cover.className='question-tile'; cover.textContent=''; cell.appendChild(cover); boardEl.appendChild(cell); } setTimeout(goReveal, HIDE_MS); }

    function goReveal(){
      phase='reveal'; feedbackEl.textContent='Which one is gone?'; renderBoard(true);
      const basePool = (categoryKey==='mixed') ? ALL_ITEMS : CATEGORIES[categoryKey];
      const others = basePool.filter(x=>x!==hiddenSrc); const distractors = sample(others, 3); const opts = shuffle([hiddenSrc, ...distractors]);
      renderChoices(opts); choicesEl.classList.remove('hidden'); setTimeout(()=>{ const firstBtn=choicesEl.querySelector('.choice-btn'); if(firstBtn) firstBtn.focus(); }, 10); phase='answer';
    }

    function onChoiceClick(e){ if(phase!=='answer') return; const btn=e.currentTarget; const chosen=btn.dataset.src; if(chosen===hiddenSrc){ feedbackEl.textContent='Great memory!'; btn.classList.add('pulse'); playSafe(sfxCorrect); playSafe(voicesPos[Math.floor(Math.random()*voicesPos.length)]); if(firstPick) sessionFirstTryCount++; const roundsPlayed=lsGet(METRIC_KEYS.roundsPlayed,0)+1; lsSet(METRIC_KEYS.roundsPlayed, roundsPlayed); if(firstPick){ lsSet(METRIC_KEYS.correctFirst, lsGet(METRIC_KEYS.correctFirst,0)+1); } const respMs=performance.now()-studyStartMs; const prevAvg=lsGet(METRIC_KEYS.avgMs,0); const newAvg= prevAvg===0? respMs : Math.round((prevAvg*0.8)+(respMs*0.2)); lsSet(METRIC_KEYS.avgMs,newAvg); pushRecent(gridSet); setTimeout(()=>{ roundIndex++; if(roundIndex<ROUNDS){ goStudy(); } else { goEnd(); } }, 700); } else { feedbackEl.textContent='Try again.'; btn.classList.add('wobble'); playSafe(sfxWrong); playSafe(voicesTry[Math.floor(Math.random()*voicesTry.length)]); firstPick=false; setTimeout(()=>btn.classList.remove('wobble'), 500); } }

    function goEnd(){
      phase='end'; gameEl.classList.add('hidden'); endEl.classList.remove('hidden');
      const perfect = sessionFirstTryCount===ROUNDS;
      endHeadlineEl.textContent = perfect ? 'You remembered them all!' : (Math.random()<0.5 ? 'Great memory!' : 'Good effort!');
      endScoreEl.textContent = `You’ve got ${sessionFirstTryCount} out of ${ROUNDS} scores!`;
      const full='assets/memory2/images/ui/star-full.png'; const empty='assets/memory2/images/ui/star-empty.png';
      let stars=0; if(sessionFirstTryCount===5) stars=3; else if(sessionFirstTryCount>=3) stars=2; else if(sessionFirstTryCount>=1) stars=1; else stars=0;
      starRowEl.innerHTML=''; for(let i=0;i<3;i++){ const img=smartImg(i<stars?full:empty,'','star'); img.style.width='40px'; img.style.height='40px'; const holder=document.createElement('div'); holder.style.width='48px'; holder.style.height='48px'; holder.style.display='flex'; holder.style.alignItems='center'; holder.style.justifyContent='center'; holder.appendChild(img); starRowEl.appendChild(holder); }
      try{ resultsChime.currentTime=0; resultsChime.play().catch(()=>{}); }catch{}
      try{ (Math.random()<0.5 ? voiceEndA : voiceEndB).play().catch(()=>{}); }catch{}
    }

    function stopAllAudio(){ try{ bgm.pause(); bgm.currentTime=0; }catch{} [sfxCorrect,sfxWrong,resultsChime,...voicesPos,...voicesTry,voiceEndA,voiceEndB].forEach(a=>{ try{ a.pause(); a.currentTime=0; }catch{} }); }

    // Controls
    startBtn.addEventListener('click', ()=>{ roundIndex=0; sessionFirstTryCount=0; goStudy(); });
    playAgainBtn.addEventListener('click', ()=>{ roundIndex=0; sessionFirstTryCount=0; goStudy(); });
    function goHome(){ stopAllAudio(); window.location.href='lesson-screen-htmls/lesson-04.02.html'; }
    homeBtn.addEventListener('click', goHome);
    homeBtn2.addEventListener('click', goHome);
    howToBtn.addEventListener('click', ()=>{ howToPanel.classList.toggle('hidden'); });

    // Debug
    window.__memory2__ = { getMetrics: () => ({ roundsPlayed: lsGet(METRIC_KEYS.roundsPlayed,0), correctFirstTry: lsGet(METRIC_KEYS.correctFirst,0), avgResponseMs: lsGet(METRIC_KEYS.avgMs,0), lastUsedSetIds: lsGet(METRIC_KEYS.lastUsed,[]) })};

    goIntro();
  </script>
</body>
</html>
