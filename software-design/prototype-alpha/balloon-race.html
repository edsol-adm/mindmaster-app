<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MindMaster ‚Äî Balloon Race ¬∑ Think ¬∑ Feel ¬∑ Do</title>
  <style>
    :root{
      --bg:#FFF176;             /* cheerful pastel yellow */
      --ink:#111827;            /* near-black for high contrast */
      --rail:#ffeaa6;           /* timer rail */
      --bar:#111827;            /* timer bar (dark for contrast) */
      --btn-blue:#42A5F5;       /* Thinking */
      --btn-blue-b:#1E88E5;
      --btn-red:#FF4136;        /* Feeling */
      --btn-red-b:#C12B22;
      --btn-green:#2ECC40;      /* Doing */
      --btn-green-b:#22A732;
      --gap:10px;
    }
    html,body{height:100%}
    body{
      margin:0; padding:0; background:var(--bg); color:var(--ink);
      font-family:'Comic Neue', system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      display:flex; flex-direction:column; align-items:center; min-height:100vh; overflow:hidden;
    }
    .hidden{display:none !important;}
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    /* INTRO */
    #intro{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:20; }
    #intro::before{
      content:""; position:absolute; inset:0;
      background: url('assets/balloon-race/images/ui/bg-launch.png') center/cover no-repeat;
      filter:none; opacity:1;
    }
    .intro-card{
      position:relative; z-index:1; width:min(760px,92vw);
      background:#fffdfdd9; border-radius:22px; padding:22px;
      box-shadow:0 14px 34px rgba(0,0,0,0.25); text-align:center;
    }
    h1{ margin:8px 0 2px; font-size:2.2rem; }
    .sub{ margin:0 0 12px; font-size:1.05rem; }
    .controls{ margin:12px 0; display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }
    button{
      padding:12px 18px; border-radius:16px; border:2px solid #0000; cursor:pointer;
      background:#fff; color:var(--ink); font-weight:700; font-size:1rem; box-shadow:0 3px 0 rgba(0,0,0,0.15);
      transition:transform .08s ease, filter .08s ease;
    }
    button:focus{ outline:3px solid #000; outline-offset:2px }
    button:active{ transform:translateY(1px) }
    .btn-blue{ background:var(--btn-blue); color:#fff; border-color:var(--btn-blue-b); }
    .btn-blue:hover{ filter:brightness(.9); }
    .btn-red{ background:var(--btn-red); color:#fff; border-color:var(--btn-red-b); }
    .btn-red:hover{ filter:brightness(.9); }
    .btn-green{ background:var(--btn-green); color:#fff; border-color:var(--btn-green-b); }
    .btn-green:hover{ filter:brightness(.9); }
    .btn-outline{ background:#fff; color:var(--ink); border:2px solid var(--ink); }

    /* GAME */
    #game{ width:min(980px,96vw); margin:12px auto 0; display:flex; flex-direction:column; align-items:center; gap:8px; }
    #topBar{ width:100%; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    #roundLabel{ font-weight:800; }
    .timer-rail{ flex:1 1 auto; height:10px; background:var(--rail); border-radius:999px; overflow:hidden; }
    .timer-bar{ height:100%; width:100%; background:var(--bar); transform-origin:left; }

    /* Zero-scroll guardrails @1024√ó768: 320 + 8 + 220 + 6 + 160 = 714 */
    .stim-row{ width:100%; height:320px; display:flex; align-items:center; justify-content:center; }
    .stim-card{
      width:720px; height:320px; background:#fff; border-radius:16px; box-shadow:0 4px 10px rgba(0,0,0,.12);
      display:grid; grid-template-rows: 300px 20px; align-items:center; justify-items:center; padding:0;
    }
    .stim-img{ width:300px; height:300px; object-fit:contain; }
    .stim-cap{ font-size:22px; line-height:22px; margin-top:-2px; }
    .balloon-row{ width:100%; height:220px; display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; align-items:center; justify-items:center; }
    .balloon-slot{ width:160px; height:160px; position:relative; }
    .balloon-slot img{ width:100%; height:100%; object-fit:contain; }
    .balloon-label{ margin-top:6px; font-weight:700; text-align:center; }

    .vote-row{ position:fixed; left:50%; transform:translateX(-50%); bottom:0; width:min(980px,96vw); height:160px;
      display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; align-items:center; padding:12px 0 16px; background:linear-gradient(180deg, rgba(255,241,118,0) 0%, rgba(255,241,118,0.85) 40%, rgba(255,241,118,1) 100%);
    }
    .vote-btn{ min-height:64px; font-size:1.2rem; font-weight:800; border-radius:18px; border:2px solid #0003; }
    .vote-btn:focus{ outline:3px solid #000; outline-offset:2px; }

    /* BETWEEN */
    #between{
      position:fixed; inset:0; background:rgba(0,0,0,0.35);
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px;
      z-index:30;
    }
    .stars{ display:flex; gap:10px; }
    .sparkle{ animation:sparkle 900ms ease infinite; }
    @keyframes sparkle{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.15)} }

    /* END */
    #end{ text-align:center; margin-top:20px; }
    #starsRow img{ width:96px; height:96px; }

    /* Confetti overlay on pop */
    #confetti{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      pointer-events:none; z-index:40;
    }

    /* Feedback live region */
    #feedback{ min-height:1.4rem; text-align:center; }

    /* How-to drawer in INTRO */
    #howTo{ background:#fff; border-radius:12px; padding:12px; text-align:left; }
  </style>
</head>
<body>
  <!-- INTRO / Launch Screen -->
  <section id="intro" aria-live="polite">
    <div class="intro-card" role="dialog" aria-labelledby="title">
      <h1 id="title">Balloon Race ‚Äî Think ¬∑ Feel ¬∑ Do</h1>
      <p class="sub">Classify each stimulus as <b>Thinking</b> üß†, <b>Feeling</b> ‚ù§Ô∏è, or <b>Doing</b> üèÉ. Get three right to pop the round‚Äôs balloon!</p>
      <div class="controls">
        <button id="btnStart" class="btn-blue" aria-label="Start">Start</button>
        <button id="btnHow" class="btn-outline" aria-controls="howTo" aria-expanded="false">How to Play</button>
        <button id="btnHome" class="btn-outline">Return to the Park</button>
      </div>
      <div id="howTo" class="hidden">
        <ol style="margin:8px 0 0 18px;">
          <li>We‚Äôll show an image and speak a caption.</li>
          <li>When the voice finishes, a 12-second timer starts.</li>
          <li>Press <b>1</b> for Thinking, <b>2</b> for Feeling, <b>3</b> for Doing. You‚Äôll also see big coloured buttons.</li>
          <li>Correct answers grow the balloons. Three correct in the focus category pops it!</li>
        </ol>
      </div>
      <p class="sr-only">No audio plays on the intro screen.</p>
    </div>
  </section>

  <!-- GAME -->
  <section id="game" class="hidden" aria-live="polite">
    <div id="topBar">
      <div id="roundLabel">Round 1/3</div>
      <div class="timer-rail" aria-hidden="true"><div id="timerBar" class="timer-bar"></div></div>
      <img src="assets/balloon-race/images/ui/timer-icon.png" alt="" aria-hidden="true" style="width:22px;height:22px"/>
    </div>

    <div id="feedback" aria-live="polite"></div>

    <div class="stim-row">
      <div class="stim-card" aria-label="Stimulus">
        <img id="stimImg" class="stim-img" src="" alt=""/>
        <div id="stimCap" class="stim-cap"></div>
      </div>
    </div>

    <div class="balloon-row" role="group" aria-label="Balloon growth">
      <div class="balloon-col" aria-live="polite" aria-label="Thinking balloon">
        <div class="balloon-slot"><img id="balloon-thinking" src="assets/balloon-race/images/balloons/balloon-blue-1.png" alt="Thinking balloon size 1 of 4"/></div>
        <div class="balloon-label">Thinking üß†</div>
      </div>
      <div class="balloon-col" aria-live="polite" aria-label="Feeling balloon">
        <div class="balloon-slot"><img id="balloon-feeling" src="assets/balloon-race/images/balloons/balloon-red-1.png" alt="Feeling balloon size 1 of 4"/></div>
        <div class="balloon-label">Feeling ‚ù§Ô∏è</div>
      </div>
      <div class="balloon-col" aria-live="polite" aria-label="Doing balloon">
        <div class="balloon-slot"><img id="balloon-doing" src="assets/balloon-race/images/balloons/balloon-green-1.png" alt="Doing balloon size 1 of 4"/></div>
        <div class="balloon-label">Doing üèÉ</div>
      </div>
    </div>

    <div class="vote-row" role="group" aria-label="Choose category">
      <button id="btn1" class="vote-btn btn-blue"  aria-label="1 Thinking">1 Thinking üß†</button>
      <button id="btn2" class="vote-btn btn-red"   aria-label="2 Feeling">2 Feeling ‚ù§Ô∏è</button>
      <button id="btn3" class="vote-btn btn-green" aria-label="3 Doing">3 Doing üèÉ</button>
    </div>
  </section>

  <!-- BETWEEN -->
  <section id="between" class="hidden" aria-hidden="true">
    <div class="stars">
      <img class="sparkle" src="assets/balloon-race/images/ui/star-full.png" alt=""/>
      <img class="sparkle" src="assets/balloon-race/images/ui/star-full.png" alt=""/>
      <img class="sparkle" src="assets/balloon-race/images/ui/star-full.png" alt=""/>
    </div>
    <div id="betweenMsg" class="sub" style="color:#fff; font-weight:800;"></div>
  </section>

  <!-- CONFETTI -->
  <div id="confetti" class="hidden" aria-hidden="true">
    <img src="assets/balloon-race/images/balloons/confetti-burst.gif" alt="" style="width:500px;height:500px;"/>
  </div>

  <!-- END -->
  <section id="end" class="hidden">
    <h2 id="endHeadline">Great teamwork!</h2>
    <div id="starsRow" aria-label="Star rating"></div>
    <p id="endSub" class="sub">Play again to master Think ¬∑ Feel ¬∑ Do.</p>
    <div class="controls">
      <button id="btnAgain" class="btn-blue">Play Again</button>
      <button id="btnHome2" class="btn-outline">Return to the Park</button>
    </div>
  </section>

  <!-- AUDIO -->
  <audio id="bgm" src="assets/balloon-race/audio/bgm.mp3" loop></audio>

  <!-- SFX -->
  <audio id="sfxCorrect"  src="assets/balloon-race/sfx/correct.mp3"></audio>
  <audio id="sfxWrong"    src="assets/balloon-race/sfx/wrong.mp3"></audio>
  <audio id="sfxCountdown"src="assets/balloon-race/sfx/countdown.mp3"></audio>
  <audio id="sfxTimesUp"  src="assets/balloon-race/sfx/timesup.mp3"></audio>
  <audio id="sfxPop"      src="assets/balloon-race/sfx/pop.mp3"></audio>

  <!-- VOICE (UI) -->
  <audio id="v_instruction"        src="assets/balloon-race/voice/v_instruction.mp3"></audio>
  <audio id="v_great_job"          src="assets/balloon-race/voice/v_great_job.mp3"></audio>
  <audio id="v_fantastic"          src="assets/balloon-race/voice/v_fantastic.mp3"></audio>
  <audio id="v_awesome"            src="assets/balloon-race/voice/v_awesome.mp3"></audio>
  <audio id="v_try_again"          src="assets/balloon-race/voice/v_try_again.mp3"></audio>
  <audio id="v_check_carefully"    src="assets/balloon-race/voice/v_check_carefully.mp3"></audio>
  <audio id="v_pop_voice"          src="assets/balloon-race/voice/v_pop.mp3"></audio>
  <audio id="v_round2_success"     src="assets/balloon-race/voice/v_round2_success.mp3"></audio>
  <audio id="v_round3_success"     src="assets/balloon-race/voice/v_round3_success.mp3"></audio>
  <audio id="v_round2_fail"        src="assets/balloon-race/voice/v_round2_fail.mp3"></audio>
  <audio id="v_round3_fail"        src="assets/balloon-race/voice/v_round3_fail.mp3"></audio>

  <!-- VOICE (stimulus captions) -->
  <audio id="v_stim-thinking-01" src="assets/balloon-race/voice/stimuli/v_stim-thinking-01.wav"></audio>
  <audio id="v_stim-thinking-02" src="assets/balloon-race/voice/stimuli/v_stim-thinking-02.wav"></audio>
  <audio id="v_stim-thinking-03" src="assets/balloon-race/voice/stimuli/v_stim-thinking-03.wav"></audio>
  <audio id="v_stim-thinking-04" src="assets/balloon-race/voice/stimuli/v_stim-thinking-04.wav"></audio>
  <audio id="v_stim-feeling-01"  src="assets/balloon-race/voice/stimuli/v_stim-feeling-01.wav"></audio>
  <audio id="v_stim-feeling-02"  src="assets/balloon-race/voice/stimuli/v_stim-feeling-02.wav"></audio>
  <audio id="v_stim-feeling-03"  src="assets/balloon-race/voice/stimuli/v_stim-feeling-03.wav"></audio>
  <audio id="v_stim-feeling-04"  src="assets/balloon-race/voice/stimuli/v_stim-feeling-04.wav"></audio>
  <audio id="v_stim-doing-01"    src="assets/balloon-race/voice/stimuli/v_stim-doing-01.wav"></audio>
  <audio id="v_stim-doing-02"    src="assets/balloon-race/voice/stimuli/v_stim-doing-02.wav"></audio>
  <audio id="v_stim-doing-03"    src="assets/balloon-race/voice/stimuli/v_stim-doing-03.wav"></audio>
  <audio id="v_stim-doing-04"    src="assets/balloon-race/voice/stimuli/v_stim-doing-04.wav"></audio>

  <script>
  // ========= Constants & Spec =========
  const ROUND_TOTAL = 3;
  const STIM_PER_ROUND = 6;
  const PER_STIM_MS = 12000;
  const BETWEEN_SUCCESS_MS = 2500;
  const BETWEEN_FAIL_MS = 4500;
  const CONFETTI_MS = 1500;

  // Focus order fixed so each pops once: Thinking ‚Üí Feeling ‚Üí Doing
  const FOCUS_SEQ = ['thinking','feeling','doing'];

  // Button colors (already styled via classes)
  const COLORS = {
    thinking: {btn:'btn-blue',   imgBase:'balloon-blue',  label:'Thinking üß†'},
    feeling:  {btn:'btn-red',    imgBase:'balloon-red',   label:'Feeling ‚ù§Ô∏è'},
    doing:    {btn:'btn-green',  imgBase:'balloon-green', label:'Doing üèÉ'}
  };

  // Manifest for 12 stimuli (image + voice id + category)
  const STIM = {
    thinking: [
      {img:'assets/balloon-race/images/stimuli/stim-thinking-01.png', voice:'v_stim-thinking-01', cap:''},
      {img:'assets/balloon-race/images/stimuli/stim-thinking-02.png', voice:'v_stim-thinking-02', cap:''},
      {img:'assets/balloon-race/images/stimuli/stim-thinking-03.png', voice:'v_stim-thinking-03', cap:''},
      {img:'assets/balloon-race/images/stimuli/stim-thinking-04.png', voice:'v_stim-thinking-04', cap:''}
    ],
    feeling: [
      {img:'assets/balloon-race/images/stimuli/stim-feeling-01.png', voice:'v_stim-feeling-01', cap:''},
      {img:'assets/balloon-race/images/stimuli/stim-feeling-02.png', voice:'v_stim-feeling-02', cap:''},
      {img:'assets/balloon-race/images/stimuli/stim-feeling-03.png', voice:'v_stim-feeling-03', cap:''},
      {img:'assets/balloon-race/images/stimuli/stim-feeling-04.png', voice:'v_stim-feeling-04', cap:''}
    ],
    doing: [
      {img:'assets/balloon-race/images/stimuli/stim-doing-01.png', voice:'v_stim-doing-01', cap:''},
      {img:'assets/balloon-race/images/stimuli/stim-doing-02.png', voice:'v_stim-doing-02', cap:''},
      {img:'assets/balloon-race/images/stimuli/stim-doing-03.png', voice:'v_stim-doing-03', cap:''},
      {img:'assets/balloon-race/images/stimuli/stim-doing-04.png', voice:'v_stim-doing-04', cap:''}
    ]
  };

  // UI elements
  const intro = document.getElementById('intro');
  const btnStart = document.getElementById('btnStart');
  const btnHow = document.getElementById('btnHow');
  const btnHome = document.getElementById('btnHome');
  const howTo = document.getElementById('howTo');

  const game = document.getElementById('game');
  const roundLabel = document.getElementById('roundLabel');
  const timerBar = document.getElementById('timerBar');
  const feedback = document.getElementById('feedback');
  const stimImg = document.getElementById('stimImg');
  const stimCap = document.getElementById('stimCap');

  const balloonImg = {
    thinking: document.getElementById('balloon-thinking'),
    feeling : document.getElementById('balloon-feeling'),
    doing   : document.getElementById('balloon-doing')
  };

  const voteBtns = {
    1: document.getElementById('btn1'),
    2: document.getElementById('btn2'),
    3: document.getElementById('btn3')
  };

  const between = document.getElementById('between');
  const betweenMsg = document.getElementById('betweenMsg');
  const confetti = document.getElementById('confetti');
  const end = document.getElementById('end');
  const endHeadline = document.getElementById('endHeadline');
  const endSub = document.getElementById('endSub');
  const starsRow = document.getElementById('starsRow');
  const btnAgain = document.getElementById('btnAgain');
  const btnHome2 = document.getElementById('btnHome2');

  // Audio
  const bgm = document.getElementById('bgm');
  const sfxCorrect = document.getElementById('sfxCorrect');
  const sfxWrong = document.getElementById('sfxWrong');
  const sfxCountdown = document.getElementById('sfxCountdown');
  const sfxTimesUp = document.getElementById('sfxTimesUp');
  const sfxPop = document.getElementById('sfxPop');

  const v_instruction = document.getElementById('v_instruction');
  const vPositives = [document.getElementById('v_great_job'), document.getElementById('v_fantastic'), document.getElementById('v_awesome')];
  const vHints = [document.getElementById('v_try_again'), document.getElementById('v_check_carefully')];
  const v_pop_voice = document.getElementById('v_pop_voice');
  const v_round2_success = document.getElementById('v_round2_success');
  const v_round3_success = document.getElementById('v_round3_success');
  const v_round2_fail = document.getElementById('v_round2_fail');
  const v_round3_fail = document.getElementById('v_round3_fail');

  // Stimulus voice map by id
  const stimVoices = {};
  ['thinking','feeling','doing'].forEach(cat => {
    STIM[cat].forEach(s => { stimVoices[s.voice] = document.getElementById(s.voice); });
  });

  // State
  let roundIndex = 0;            // 0..2
  let focus = FOCUS_SEQ[0];
  let steps = {thinking:1, feeling:1, doing:1};  // 1..4
  let popped = {thinking:false, feeling:false, doing:false};
  let score = 0;
  let totalShown = 0;
  let currentStim = null;
  let stimQueue = [];
  let accepting = false;
  let rafId = null;
  let timerStart = 0;
  let countdownMarksPlayed = {9:false,10:false,11:false};
  let instructionPlayed = false;
  let bgmWanted = false;

  // Helpers
  function play(audio){ try{ audio.currentTime = 0; audio.play().catch(()=>{}); }catch{} }
  function stop(audio){ try{ audio.pause(); }catch{} }
  function duckBgm(down){
    try{
      if(down){ bgm.volume = 0.15; } else { bgm.volume = 0.35; }
    }catch{}
  }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function sample(arr, n){ const c=[...arr]; shuffle(c); return c.slice(0,n); }

  // Build per-round queue: 3 focus + 3 distractors (2 from one other, 1 from remaining)
  function buildRoundQueue(roundIdx){
    const focusCat = FOCUS_SEQ[roundIdx];
    const otherCats = ['thinking','feeling','doing'].filter(c=>c!==focusCat);
    const focusItems = sample(STIM[focusCat], 3); // 3 focus
    const twoFrom = sample(STIM[otherCats[0]], 2);
    const oneFrom = sample(STIM[otherCats[1]], 1);
    const q = shuffle([...focusItems.map(s=>({...s, cat:focusCat, isFocus:true})), ...twoFrom.map(s=>({...s, cat:otherCats[0], isFocus:false})), ...oneFrom.map(s=>({...s, cat:otherCats[1], isFocus:false}))]);
    return q;
  }

  // Reset balloons at round start
  function resetBalloons(){
    steps = {thinking:1, feeling:1, doing:1};
    popped = {thinking:false, feeling:false, doing:false};
    setBalloon('thinking');
    setBalloon('feeling');
    setBalloon('doing');
  }
  function setBalloon(cat){
    const imgBase = COLORS[cat].imgBase;
    const el = balloonImg[cat];
    const step = steps[cat];
    if(step>=4 && popped[cat]){
      el.src = `assets/balloon-race/images/balloons/${imgBase}-pop.png`;
      el.alt = `${cat} balloon popped`;
    }else{
      const clamped = Math.min(4, Math.max(1, step));
      el.src = `assets/balloon-race/images/balloons/${imgBase}-${clamped}.png`;
      el.alt = `${COLORS[cat].label.split(' ')[0]} balloon size ${clamped} of 4`;
    }
  }

  // ========= FSM =========
  function startSession(){
    intro.classList.add('hidden');
    game.classList.remove('hidden');
    end.classList.add('hidden');
    document.body.style.overflow='hidden';
    bgmWanted = true;
    try{ bgm.volume = 0.35; bgm.play().catch(()=>{}); }catch{}
    queueVoices([v_instruction], ()=>{
      beginRound(0);
    });
  }

  function beginRound(idx){
    roundIndex = idx;
    focus = FOCUS_SEQ[roundIndex];
    roundLabel.textContent = `Round ${roundIndex+1}/${ROUND_TOTAL}`;
    resetBalloons();
    stimQueue = buildRoundQueue(roundIndex);
    totalShown = 0;
    accepting = false;
    clearTimer();
    nextStimulus();
  }

  function nextStimulus(){
    clearTimer();
    if(stimQueue.length===0){
      if(!popped[focus]){
        doBetween(false);
      }else{
        doBetween(true);
      }
      return;
    }
    currentStim = stimQueue.shift();
    totalShown++;
    renderStimulus(currentStim);
    const v = stimVoices[currentStim.voice];
    queueVoices([v], ()=>{
      startTimer();
      accepting = true;
    });
  }

  function renderStimulus(s){
    stimImg.src = s.img;
    stimImg.alt = '';
    stimCap.textContent = s.cap || '';
    feedback.textContent = '';
    countdownMarksPlayed = {9:false,10:false,11:false};
  }

  function startTimer(){
    const startTs = performance.now();
    timerStart = startTs;
    timerBar.style.width = '100%';
    cancelAnimationFrame(rafId);
    function frame(now){
      const elapsed = now - startTs;
      const percent = Math.max(0, 1 - (elapsed/12000)) * 100;
      timerBar.style.width = percent + '%';
      const secs = Math.floor(elapsed/1000);
      [9,10,11].forEach(mark=>{
        if(secs>=mark && !countdownMarksPlayed[mark]){
          countdownMarksPlayed[mark]=true;
          play(sfxCountdown);
        }
      });
      if(elapsed>=PER_STIM_MS){
        timerBar.style.width = '0%';
        accepting = false;
        play(sfxTimesUp);
        clearTimer();
        setTimeout(()=>nextStimulus(), 250);
        return;
      }
      rafId = requestAnimationFrame(frame);
    }
    rafId = requestAnimationFrame(frame);
  }
  function clearTimer(){ if(rafId){ cancelAnimationFrame(rafId); rafId=null; } timerBar.style.width='100%'; }

  function handleChoice(n){
    if(!accepting) return;
    accepting = false;
    const chosenCat = (n===1?'thinking': n===2?'feeling':'doing');
    const isCorrect = (chosenCat === currentStim.cat);
    if(isCorrect){
      score++;
      play(sfxCorrect);
      play(randFrom(vPositives));
      const targetCat = currentStim.cat;
      if(currentStim.isFocus){
        steps[targetCat] = Math.min(4, steps[targetCat]+1);
        if(steps[targetCat]===4){
          doPop(targetCat);
          return;
        }
      }else{
        steps[targetCat] = Math.min(2, steps[targetCat]+1);
      }
      setBalloon(targetCat);
      setTimeout(()=>nextStimulus(), 300);
    }else{
      play(sfxWrong);
      play(randFrom(vHints));
      feedback.textContent = 'Try again!';
      setTimeout(()=>nextStimulus(), 500);
    }
  }
  function randFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function doPop(cat){
    steps[cat]=4; setBalloon(cat);
    popped[cat]=true;
    play(sfxPop);
    queueVoices([v_pop_voice], ()=>{});
    confetti.classList.remove('hidden');
    setTimeout(()=>{
      confetti.classList.add('hidden');
      doBetween(true);
    }, CONFETTI_MS);
  }

  function doBetween(success){
    clearTimer();
    between.classList.remove('hidden');
    let ms = success ? BETWEEN_SUCCESS_MS : BETWEEN_FAIL_MS;
    if(roundIndex===1){
      play(success ? v_round2_success : v_round2_fail);
    }else if(roundIndex===2){
      play(success ? v_round3_success : v_round3_fail);
    }
    betweenMsg.textContent = success ? `Boom! ${COLORS[focus].label.split(' ')[0]} balloon popped! Get ready for Round ${Math.min(3, roundIndex+2)}.`
                                     : `Time‚Äôs up! Let‚Äôs see if you can do it in Round ${Math.min(3, roundIndex+2)}.`;

    setTimeout(()=>{
      between.classList.add('hidden');
      if(roundIndex+1 < ROUND_TOTAL){
        beginRound(roundIndex+1);
      }else{
        showEnd();
      }
    }, ms);
  }

  function showEnd(){
    game.classList.add('hidden');
    end.classList.remove('hidden');
    const pct = Math.round((score / (ROUND_TOTAL*STIM_PER_ROUND))*100);
    endHeadline.textContent = pct>=95 ? 'You nailed it!' : pct>=80 ? 'Fantastic effort!' : pct>=60 ? 'Good job!' : 'Nice try!';
    endSub.textContent = 'Play again to master Think ¬∑ Feel ¬∑ Do';
    starsRow.innerHTML='';
    const stars = (pct>=95)?3 : (pct>=80)?2 : (pct>=60)?1 : 0;
    for(let i=0;i<3;i++){
      const img = document.createElement('img');
      img.src = i<stars ? 'assets/balloon-race/images/ui/star-full.png' : 'assets/balloon-race/images/ui/star-empty.png';
      img.alt = i<stars ? 'star' : 'empty star';
      img.className = 'sparkle';
      starsRow.appendChild(img);
    }
    window.__balloonRace__ = {
      getMetrics: () => ({ roundIndex, score, totalShown, steps, popped })
    };
  }

  let voiceQueue = [];
  let speaking = false;
  function queueVoices(list, onDone){
    voiceQueue = [...list];
    function next(){
      if(voiceQueue.length===0){ speaking=false; duckBgm(false); onDone && onDone(); return; }
      const a = voiceQueue.shift();
      if(!a){ next(); return; }
      speaking = true;
      duckBgm(true);
      try{
        a.currentTime=0;
        a.play().then(()=>{
          a.onended = ()=>{ a.onended=null; next(); };
        }).catch(()=>{ next(); });
      }catch{ next(); }
    }
    next();
  }

  document.addEventListener('keydown', (e)=>{
    if(e.key==='1') handleChoice(1);
    else if(e.key==='2') handleChoice(2);
    else if(e.key==='3') handleChoice(3);
  });

  voteBtns[1].addEventListener('click', ()=>handleChoice(1));
  voteBtns[2].addEventListener('click', ()=>handleChoice(2));
  voteBtns[3].addEventListener('click', ()=>handleChoice(3));

  window.addEventListener('message', (e)=>{
    try{
      if(e?.data && [1,2,3].includes(e.data.choice)) handleChoice(e.data.choice);
    }catch{}
  });

  btnStart.addEventListener('click', startSession);
  btnHow.addEventListener('click', ()=>{
    const isOpen = !howTo.classList.contains('hidden');
    howTo.classList.toggle('hidden');
    btnHow.setAttribute('aria-expanded', String(!isOpen));
  });
  function goHome(){ try{ bgm.pause(); }catch{} window.location.href='lesson-screen-htmls/lesson-01.01.html'; }
  btnHome.addEventListener('click', goHome);
  btnHome2.addEventListener('click', goHome);
  btnAgain.addEventListener('click', ()=>{ score=0; startSession(); });

  function primeBgm(){ if(!bgmWanted){ bgmWanted=true; try{ bgm.volume=0.35; bgm.play().catch(()=>{});}catch{} } }
  window.addEventListener('pointerdown', (e)=>{
    const isBtn = e.target.closest('button');
    if(!isBtn){ primeBgm(); if(bgm) try{ bgm.currentTime=0; }catch{} }
  }, {passive:true});
  window.addEventListener('keydown', ()=>{ primeBgm(); }, {passive:true});

  window.addEventListener('resize', ()=>{ document.body.style.overflow='hidden'; });

  </script>
</body>
</html>
