<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MindMaster • Offline Prototype (L2 • U4 • L1)</title>
  <style>
    /* =========================================
       MindMaster • Offline single-file prototype (Edited Spec v3)
       Implements: 2 levels × 5 units × 3 lessons
       Playable: Level 2 → Unit 4 → Lesson 1 only
       Routes: #/menu, #/lesson/l2/u4/l1
       ========================================= */

    :root{
      --bg: #f8fafc;          /* app background (unused, kept for compatibility) */
      --text: #0f172a;        /* text */
      --muted: #64748b;       /* muted text */
      --card: #ffffff;        /* cards */
      --line: #e5e7eb;        /* borders */
      --brand: #36B0A1;       /* brand teal */
      --accentA: #f97316;     /* orange */
      --accentB: #3b82f6;     /* blue  */
      --accentC: #10b981;     /* green */
      --goodBg: #ecfdf5;      /* toast good */
      --goodTx: #065f46;
      --badBg:  #fef2f2;      /* toast bad */
      --badTx:  #7f1d1d;
      --hintBg: #fffbeb;      /* toast hint */
      --hintTx: #92400e;
      --menuPink: #FFB6C1;    /* Light Pink background for menu + lessons */
    }

    html, body { height: 100%; }
    body{
      margin:0;
      background: var(--menuPink); /* Spec: Light Pink on ALL screens */
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.35;
    }

    /* App shell */
    #app{ min-height:100vh; display:grid; grid-template-rows:auto 1fr; }
    header.appbar{ position:sticky; top:0; z-index:10; display:flex; align-items:center; gap:12px; padding:12px 16px; background: rgba(255,255,255,0.9); backdrop-filter: saturate(180%) blur(8px); border-bottom:1px solid var(--line); }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:0.2px; }
    .logo{ width:28px; height:28px; border-radius:8px; background: conic-gradient(from 180deg, var(--brand), #99e6dd); }
    .space{ flex: 1 1 auto; }
    .btn, button{ -webkit-tap-highlight-color: transparent; cursor:pointer; border:1px solid var(--line); background:#fff; color:var(--text); padding:10px 14px; border-radius:12px; font-weight:700; box-shadow: 0 1px 0 rgba(0,0,0,0.04) inset, 0 2px 8px rgba(0,0,0,0.06); }
    .btn:focus-visible, button:focus-visible{ outline:3px solid var(--brand); outline-offset:2px; }
    .btn[disabled], button[disabled]{ opacity:0.5; cursor:not-allowed; }

    main{ padding:18px; }
    .container{ max-width:1100px; margin:0 auto; }

    /* ====== Type ramps per spec ====== */
    /* Menu text & buttons → Fredoka Semibold (fallbacks if not installed) */
    .menu-root, .menu-root .btn, .menu-root .lesson-btn, .menu-root .unit-title, .menu-root h2{
      font-family: 'Fredoka', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      font-weight: 600;
    }
    /* Lesson headers → Comic Neue Semibold */
    .lesson-title, .stage-header h3{ font-family: 'Comic Neue', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; font-weight:600; }
    /* Tabs: active → Semibold; inactive → Regular */
    .tabs .tab{ font-family: 'Comic Neue', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; font-weight:400; }
    .tabs .tab.active, .tabs .tab.done{ font-weight:600; }

    /* ====== Shared answer button animation & selection glow (spec) ====== */
    .answer-button{
      transition: transform 0.2s ease;
      font-family: 'Comic Neue', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      font-weight: 400; /* Regular by default */
    }
    .answer-button:hover{ transform: scale(0.95); }
    .answer-button.selected{ box-shadow: 0 0 8px 2px rgba(0, 123, 255, 0.5); }

    /* Pills & badges */
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:#fff; border:1px solid var(--line); color:#334155; font-size:12px; }
    .dot{ width:8px; height:8px; border-radius:50%; background:#94a3b8; }

    /* Cards */
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); }

    /* MENU GRID */
    .section{ display:flex; align-items:center; justify-content:space-between; margin:8px 0 6px; }
    .section h2{ margin:0; font-size:20px; letter-spacing:0.3px; }
    .menu-grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:14px; }
    .unit-card{ grid-column: span 6; display:flex; flex-direction:column; gap:10px; }
    @media (min-width: 720px){ .unit-card{ grid-column: span 3; } }
    .unit-header{ display:flex; align-items:center; justify-content:space-between; }
    .unit-title{ font-weight:800; }
    .tick{ display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#065f46; }
    .lessons{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; }
    .lesson-btn{ display:flex; align-items:center; justify-content:center; gap:8px; padding:10px; border-radius:12px; background:#fff; border:1px solid var(--line); font-weight:800; }
    .lesson-btn.start{ background: linear-gradient(180deg, rgba(54,176,161,0.15), rgba(54,176,161,0.05)); border-color: var(--brand); }

    /* LESSON LAYOUT */
    .lesson-head{ display:flex; align-items:center; gap:14px; flex-wrap:wrap; margin-bottom:12px; }
    .lesson-title{ font-weight:900; font-size:18px; }

    /* Progress tabs — large & left-aligned under title */
    .tabs{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .tab{ display:flex; align-items:center; gap:10px; padding:14px 16px; border-radius:999px; background:#fff; border:2px solid var(--line); font-weight:800; font-size:18px; }
    .tab.active{ background:#eef2ff; border-color:#818cf8; }
    .tab.done{ background:#ecfdf5; border-color: var(--brand); color: var(--goodTx); box-shadow: 0 0 0 2px #baf3ea inset, 0 0 12px rgba(54,176,161,0.35); }

    /* Stage nav buttons (center) */
    .stage-nav{ display:flex; justify-content:center; gap:12px; margin: 8px 0 16px; }
    .stage-btn{ flex: 1 1 220px; max-width: 320px; padding:16px; font-size:18px; border-radius:16px; border-width:2px; }
    .s-explore{ background:#fff7ed; border-color:#fdba74; }
    .s-reflect{ background:#ecfeff; border-color:#67e8f9; }
    .s-practise{ background:#eff6ff; border-color:#93c5fd; }

    .lesson-stage{ display:none; }
    .lesson-stage.active{ display:block; }

    /* Stage headers — centered instruction & bigger */
    .stage-header{ display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; margin: 6px 0 12px; }
    .stage-header h3{ margin:0 0 6px 0; font-size: 20px; }
    .stage-header .pill{ font-size: 24px; padding: 10px 14px; }

    /* Tap cards — x2 sizing for small children (and answer-button class applied) */
    .grid-3{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    @media (max-width: 720px){ .grid-3{ grid-template-columns: 1fr 1fr; } }
    .tap-card{ user-select:none; min-height: 140px; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:10px; border-radius:16px; border:2px solid var(--line); background:#fff; font-size:18px; padding:8px; }
    .tap-card[aria-pressed="true"]{ outline:3px dashed var(--brand); outline-offset:3px; }
    .tap-card.hint{ box-shadow: 0 0 0 3px rgba(245,158,11,0.5) inset; }

    /* Baskets (Sort It) */
    .baskets{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px; }
    .basket{ min-height: 160px; padding:10px; border-radius:16px; border:2px dashed #cbd5e1; background:#f8fafc; }
    .basket h4{ margin:0 0 8px 0; font-size: 16px; color:#334155; }
    .assign-card{ background:#fff; border:2px solid var(--line); border-radius:12px; padding:12px; margin:10px 0; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .assign-actions{ display:flex; gap:8px; }
    .assign-actions button{ padding:8px 10px; font-size:14px; }
    .assign-card[draggable="true"]{ cursor:grab; }

    /* Toasts */
    .toast-layer{ position:fixed; bottom:16px; left:50%; transform:translateX(-50%); display:grid; gap:8px; z-index:999; }
    .toast{ pointer-events:none; padding:20px 28px; border-radius:14px; border:1px solid var(--line); background:#fff; color:var(--text); font-weight:800; box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
    .toast.good{ background: var(--goodBg); color: var(--goodTx); border-color:#16a34a; }
    .toast.bad { background: var(--badBg);  color: var(--badTx); border-color:#b91c1c; }
    .toast.hint{ background: var(--hintBg); color: var(--hintTx); border-color:#d97706; }

    /* Modals */
    .modal{ position:fixed; inset:0; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:900; }
    .modal.active{ display:flex; }
    .modal .sheet{ width:min(560px, 92vw); border-radius:16px; background:#fff; border:1px solid var(--line); padding:18px; text-align:center; }

    .footer-hint{ margin-top:10px; font-size:12px; color: var(--muted); }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip: rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <!-- Inline SVG symbols (no external images) -->
  <svg width="0" height="0" class="sr-only" aria-hidden="true">
    <defs>
      <symbol id="i-lock" viewBox="0 0 24 24" fill="currentColor"><path d="M6 10V8a6 6 0 1112 0v2h1a1 1 0 011 1v10a1 1 0 01-1 1H5a1 1 0 01-1-1V11a1 1 0 011-1h1zm2 0h8V8a4 4 0 00-8 0v2z"/></symbol>
      <symbol id="i-check" viewBox="0 0 24 24" fill="currentColor"><path d="M20.3 5.7a1 1 0 010 1.4l-10 10a1 1 0 01-1.4 0l-5-5a1 1 0 111.4-1.4l4.3 4.29L18.9 5.7a1 1 0 011.4 0z"/></symbol>
      <symbol id="i-play" viewBox="0 0 24 24" fill="currentColor"><path d="M6 4l14 8-14 8V4z"/></symbol>
      <symbol id="i-spark" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l1.2 4.8L18 8l-4.8 1.2L12 14l-1.2-4.8L6 8l4.8-1.2L12 2z"/></symbol>
    </defs>
  </svg>

  <div id="app">
    <header class="appbar" role="banner">
      <div class="brand" aria-label="MindMaster Home">
        <div class="logo" aria-hidden="true"></div>
        <span>MindMaster • Prototype</span>
      </div>
      <span class="pill" aria-hidden="true"><span class="dot"></span> Offline • single file</span>
      <div class="space"></div>
      <a href="#/menu" class="btn" id="menuBtn">Menu</a>
    </header>

    <main role="main">
      <div class="container">
        <div id="view"></div>
      </div>
    </main>
  </div>

  <div class="toast-layer" aria-live="polite" aria-atomic="true" id="toasts"></div>

  <!-- Completion Modal -->
  <div class="modal" id="completionModal" role="dialog" aria-modal="true" aria-labelledby="compTitle">
    <div class="sheet">
      <div style="font-size:64px; color:#16a34a; line-height:1;" aria-hidden="true">
        <svg width="64" height="64" viewBox="0 0 24 24"><use href="#i-check"></use></svg>
      </div>
      <h2 id="compTitle">Great work! Lesson complete</h2>
      <p class="footer-hint">You finished Level 2 • Unit 4 • Lesson 1</p>
      <div style="display:flex; justify-content:center; gap:10px; margin-top:10px;">
        <button id="replayBtn" class="answer-button">Replay</button>
        <button id="backMenuBtn" class="answer-button">Back to Menu</button>
      </div>
    </div>
  </div>

  <!-- Inline content JSON (no fetch) -->
  <script type="application/json" id="mm-content">{
    "levels": 2,
    "unitsPerLevel": 5,
    "lessonsPerUnit": 3,
    "lessonRoute": "#/lesson/l2/u4/l1",
    "titles": { "l2_u4": "Unit 4: Problem-Solving Basics" },
    "bank": {
      "l2_u4_l1": {
        "step1": {
          "prompt": "Tap the cards that are a problem.",
          "cards": [
            { "text": "your orange juice spills", "isProblem": true },
            { "text": "noisy classroom",         "isProblem": true },
            { "text": "friend smiles at you",     "isProblem": false },
            { "text": "broken pencil",            "isProblem": true },
            { "text": "teacher says \"good job!\"", "isProblem": false },
            { "text": "lost eraser",               "isProblem": true }
          ]
        },
        "step2": {
          "story": "Kai builds a tall lego tower, but it tumbles down. What can Kai do to solve the problem?",
          "instruction": "Choose the two best ways to help Kai.",
          "choices": [
            { "text": "Kai builds it again with a wider base.", "helpful": true,  "feedback": "Great! Building carefully makes the tower stronger." },
            { "text": "Kai asks the teacher for help.",        "helpful": true,  "feedback": "Good idea! Asking for help can solve problems." },
            { "text": "Kai leaves the blocks on the floor.",   "helpful": false, "feedback": "This doesn't help Kai fix the tower." },
            { "text": "Kai cries and stops playing.",          "helpful": false, "feedback": "Crying won't solve the problem. Try another way." }
          ]
        },
        "activities": {
          "sort": {
            "instruction": "Put each card in the right basket: Helpful or Not Helpful.",
            "helpful": ["Say sorry", "Ask for help", "Clean up spill", "Take deep breaths"],
            "not": ["Shout", "Blame others", "Ignore the mess", "Kick the blocks"]
          }
        }
      }
    }
  }</script>

  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const content = JSON.parse(document.getElementById('mm-content').textContent);
    const STORAGE_KEY = 'mm_level2_unit4_completed';

    function showToast(msg, type=''){
      const wrap = document.getElementById('toasts');
      const div = document.createElement('div');
      div.className = `toast ${type}`.trim();
      div.role = 'status';
      div.textContent = msg;
      wrap.appendChild(div);
      setTimeout(()=>{ div.style.transform = 'translateY(-8px)'; div.style.opacity = '0.98'; }, 10);
      setTimeout(()=>{ div.style.opacity = '0'; }, 1800);
      setTimeout(()=>{ wrap.removeChild(div); }, 2200);
    }

    function router(){
      const hash = location.hash || '#/menu';
      if(hash.startsWith('#/lesson/l2/u4/l1')){ renderLesson(); }
      else { renderMenu(); }
    }

    /* ============== MENU =================== */
    function renderMenu(){
      const v = document.getElementById('view');
      const done = localStorage.getItem(STORAGE_KEY) === 'true';
      const {levels, unitsPerLevel, lessonsPerUnit} = content;

      let html = '';
      html += `<div class="menu-root">`;
      html += `<div class="section"><h2>Play Menu</h2><div class="pill"><span class="dot"></span> 2 levels × 5 units × 3 lessons</div></div>`;
      html += `<div class="menu-grid">`;

      for(let L=1; L<=levels; L++){
        html += `<div class="section" style="grid-column:1/-1; margin-top:14px;"><h2>Level ${L}</h2></div>`;
        for(let u=1; u<=unitsPerLevel; u++){
          const tick = (L===2 && u===4 && done)
            ? `<span class="tick"><svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><use href="#i-check"></use></svg> Done</span>`
            : `<span class="tick" aria-hidden="true" style="opacity:0">✓</span>`;
          html += `<div class="unit-card card">
            <div class="unit-header"><div class="unit-title">Unit ${u}</div>${tick}</div>
            <div class="lessons">`;
          for(let l=1; l<=lessonsPerUnit; l++){
            const isStart = (L===2 && u===4 && l===1);
            if(isStart){
              html += `<button class="lesson-btn start" data-go="${content.lessonRoute}" aria-label="Start Level 2 Unit 4 Lesson 1"><svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><use href="#i-play"></use></svg> Start L${l}</button>`;
            } else {
              html += `<button class="lesson-btn" disabled aria-disabled="true" title="Locked"><svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><use href="#i-lock"></use></svg> L${l} 🔒</button>`;
            }
          }
          html += `</div></div>`;
        }
      }

      html += `</div>`;
      html += `<div class="footer-hint">Locked lessons show <strong>🔒</strong>. Finish L2•U4•L1 to see a ✓ on Unit 4 (Level 2).</div>`;
      html += `</div>`; // .menu-root
      v.innerHTML = html;

      $$('.lesson-btn.start').forEach(btn=> btn.addEventListener('click', ()=> location.hash = content.lessonRoute));
    }

    /* ============== LESSON =================== */
    function renderLesson(){
      const v = document.getElementById('view');
      const bank = content.bank.l2_u4_l1;

      // helpers
      const iconForThing = (t) => {
        const l = t.toLowerCase();
        if(l.includes('juice')) return '🧃💦';
        if(l.includes('noisy')) return '🔊';
        if(l.includes('friend')) return '🙂';
        if(l.includes('broken')) return '✏️';
        if(l.includes('teacher')) return '👍';
        if(l.includes('eraser')) return '🔍';
        if(l.includes('sorry')) return '🫶';
        if(l.includes('help')) return '🖐️';
        if(l.includes('clean')) return '🧹';
        if(l.includes('breath')) return '🌬️';
        if(l.includes('shout')) return '🗯️';
        if(l.includes('blame')) return '👉';
        if(l.includes('ignore')) return '🙈';
        if(l.includes('kick')) return '👟';
        return '🟦';
      };
      const shuffle = (arr)=>{ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; };

      v.innerHTML = `
        <div class="lesson-head" aria-label="Lesson header">
          <div class="lesson-title">${content.titles.l2_u4}</div>
          <div class="tabs">
            <div class="tab active" data-step="1">Explore</div>
            <div class="tab" data-step="2">Reflect</div>
            <div class="tab" data-step="3">Practise</div>
          </div>
          <div class="space"></div>
          <button id="backBtn">Back</button>
        </div>

        <div class="stage-nav" role="group" aria-label="Stage navigation">
          <button class="stage-btn s-explore" data-go="1">Let’s Look</button>
          <button class="stage-btn s-reflect" data-go="2">Think About It</button>
          <button class="stage-btn s-practise" data-go="3">Let’s Try</button>
        </div>

        <!-- STEP 1: Explore → Is it a Problem? -->
        <section class="lesson-stage active" id="stage1" aria-labelledby="s1h">
          <div class="stage-header">
            <h3 id="s1h">Step 1 · Is it a Problem?</h3>
            <div class="pill"><svg width="12" height="12" viewBox="0 0 24 24" aria-hidden="true"><use href="#i-spark"></use></svg> ${bank.step1.prompt}</div>
          </div>
          <div class="grid-3" id="s1-grid" role="group" aria-label="Tap the problem cards"></div>
          <div style="display:flex; justify-content:flex-end; margin-top:12px;"><button id="s1-next">Next</button></div>
        </section>

        <!-- STEP 2: Reflect → (Micro-story selection) -->
        <section class="lesson-stage" id="stage2" aria-labelledby="s2h">
          <div class="stage-header">
            <h3 id="s2h">Step 2 · Reflect</h3>
            <div class="pill">${bank.step2.story}</div>
            <div class="pill" style="margin-top:6px;">${bank.step2.instruction}</div>
          </div>
          <div class="grid-3" id="s2-choices" role="group" aria-label="Pick two helpful ideas"></div>
          <div style="display:flex; justify-content:flex-end; margin-top:12px;"><button id="s2-next" disabled>Next</button></div>
        </section>

        <!-- STEP 3: Practise → Sort It (only) -->
        <section class="lesson-stage" id="stage3" aria-labelledby="s3h">
          <div class="stage-header">
            <h3 id="s3h">Step 3 · Let’s Practise</h3>
            <div class="pill">${content.bank.l2_u4_l1.activities.sort.instruction}</div>
          </div>

          <div class="card" id="act-sort">
            <div id="sort-pool" aria-label="Cards" role="group"></div>
            <div class="baskets">
              <div class="basket" id="basket-helpful" data-btype="helpful" aria-label="Helpful basket"><h4>Helpful 🧺</h4></div>
              <div class="basket" id="basket-not" data-btype="not" aria-label="Not Helpful basket"><h4>Not Helpful 🧺</h4></div>
            </div>
          </div>

          <div style="display:flex; justify-content:flex-end; margin-top:12px;"><button id="finishBtn" disabled>Finish</button></div>
        </section>
      `;

      // Back
      $('#backBtn').addEventListener('click', ()=> location.hash = '#/menu');

      // Tabs & stage nav
      function goStage(n){
        $$('.lesson-stage').forEach((s,i)=> s.classList.toggle('active', (i+1)===n));
        $$('.tab').forEach((t,i)=>{
          t.classList.toggle('active', (i+1)===n);
          if((i+1)<n) t.classList.add('done');
        });
        if(n===3) checkFinish();
      }
      $$('.tab').forEach(t=> t.addEventListener('click', ()=> goStage(parseInt(t.dataset.step,10))));
      $$('.stage-btn').forEach(b=> b.addEventListener('click', ()=> goStage(parseInt(b.dataset.go,10))));

      /* ===== Step 1: Is it a Problem? ===== */
      const s1 = bank.step1;
      const s1Grid = $('#s1-grid');
      s1Grid.innerHTML = s1.cards.map((c,i)=>`
        <button class="tap-card answer-button" data-idx="${i}" data-problem="${c.isProblem}" aria-pressed="false">
          <div style="font-size:26px; opacity:0.9;" aria-hidden="true">${iconForThing(c.text)}</div>
          <div>${c.text}</div>
        </button>`).join('');
      const s1Btns = $$('#s1-grid .tap-card');
      const totalProblems = s1.cards.filter(c=>c.isProblem).length;
      let s1Correct = 0; const s1Picked = new Set();
      s1Btns.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const isProblem = btn.dataset.problem === 'true';
          const idx = btn.dataset.idx;
          if(s1Picked.has(idx)) return;
          if(isProblem){
            s1Picked.add(idx); s1Correct++;
            btn.setAttribute('aria-pressed','true');
            btn.classList.remove('hint');
            showToast('⭐ Great choice!','good');
          } else {
            btn.classList.add('hint');
            showToast('Look again!','hint');
          }
          if(s1Correct>=totalProblems){ $('#s1-next').disabled = false; }
        });
      });
      $('#s1-next').addEventListener('click', ()=> goStage(2));

      /* ===== Step 2: Reflect (Micro story, pick TWO helpful) ===== */
      const s2Wrap = $('#s2-choices');
      s2Wrap.innerHTML = bank.step2.choices.map((c,i)=>`
        <button class="tap-card answer-button" role="checkbox" aria-checked="false" data-idx="${i}" data-helpful="${c.helpful}">
          <div style="font-size:26px; opacity:0.9;" aria-hidden="true">🧩</div>
          <div>${c.text}</div>
        </button>`).join('');
      const helpfulIdx = bank.step2.choices.map((c,i)=> c.helpful ? i : -1).filter(i=> i!==-1);
      let picked = new Set();
      $$('#s2-choices .tap-card').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const i = parseInt(btn.dataset.idx,10);
          const isHelpful = btn.dataset.helpful === 'true';

          if(picked.has(i)){ picked.delete(i); btn.setAttribute('aria-checked','false'); btn.classList.remove('hint'); btn.classList.remove('selected'); }
          else { picked.add(i); btn.setAttribute('aria-checked','true'); btn.classList.add('selected'); }

          // feedback
          const fb = bank.step2.choices[i].feedback;
          if(isHelpful){ showToast(fb || 'Helpful idea!','good'); }
          else { btn.classList.add('hint'); showToast(fb || 'Not helpful','bad'); }

          // enable next only when exactly the two helpful are selected
          const ok = picked.size===2 && helpfulIdx.every(h=> picked.has(h));
          $('#s2-next').disabled = !ok;
        });
      });
      $('#s2-next').addEventListener('click', ()=> goStage(3));

      /* ===== Step 3: Practise → Sort It (only) ===== */
      const sort = content.bank.l2_u4_l1.activities.sort;
      const pool = $('#sort-pool');
      const cards = shuffle(sort.helpful.map(t=>({ label:t, helpful:true })).concat(sort.not.map(t=>({ label:t, helpful:false }))));
      pool.innerHTML = cards.map((c,i)=>`
        <div class="assign-card answer-button" data-helpful="${c.helpful}" data-id="c${i}" draggable="true">
          <div><span aria-hidden="true">${iconForThing(c.label)}</span> ${c.label}</div>
          <div class="assign-actions">
            <button class="assign answer-button" data-target="helpful" aria-label="Send to Helpful basket">Helpful</button>
            <button class="assign answer-button" data-target="not" aria-label="Send to Not Helpful basket">Not</button>
          </div>
        </div>`).join('');

      const baskets = { helpful: $('#basket-helpful'), not: $('#basket-not') };

      function maybeDone(){
        const h = baskets.helpful.querySelectorAll('.assign-card').length;
        const n = baskets.not.querySelectorAll('.assign-card').length;
        if(h===4 && n===4){ $('#finishBtn').disabled = false; showToast('Sort complete ✓','good'); }
      }

      // Click-to-assign (accessible)
      $$('#sort-pool .assign').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const card = btn.closest('.assign-card');
          const expectHelpful = btn.dataset.target === 'helpful';
          const isHelpful = card.dataset.helpful === 'true';
          if(expectHelpful === isHelpful){
            baskets[expectHelpful ? 'helpful' : 'not'].appendChild(card);
            card.querySelectorAll('.assign').forEach(b=> b.disabled = true);
            showToast('Good sort','good'); maybeDone();
          } else {
            showToast('Try the other basket.','hint');
          }
        });
      });

      // Drag & drop with snap-back on wrong (no move occurs if wrong)
      function allowDropZone(el){
        el.addEventListener('dragover', e=>{ e.preventDefault(); });
        el.addEventListener('drop', e=>{
          e.preventDefault();
          const id = e.dataTransfer.getData('text/plain');
          const card = document.querySelector(`[data-id="${id}"]`);
          if(!card) return;
          const isHelpful = card.dataset.helpful === 'true';
          const targetHelpful = el.dataset.btype === 'helpful';
          if(isHelpful===targetHelpful){
            el.appendChild(card);
            card.querySelectorAll('.assign').forEach(b=> b.disabled = true);
            showToast('Nice!','good'); maybeDone();
          } else {
            showToast('Try the other basket.','hint');
          }
        });
      }
      allowDropZone(baskets.helpful); allowDropZone(baskets.not);
      $$('#sort-pool .assign-card').forEach(card=>{
        card.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', card.dataset.id); });
      });

      // Finish → modal + localStorage
      $('#finishBtn').addEventListener('click', ()=>{
        if($('#finishBtn').disabled) return;
        localStorage.setItem(STORAGE_KEY, 'true');
        $('#completionModal').classList.add('active');
        $('#replayBtn').focus();
      });
      $('#replayBtn').addEventListener('click', ()=>{ $('#completionModal').classList.remove('active'); location.hash = content.lessonRoute; });
      $('#backMenuBtn').addEventListener('click', ()=>{ $('#completionModal').classList.remove('active'); location.hash = '#/menu'; });

      function checkFinish(){ /* in this design the only gate is Sort It */ }
    }

    window.addEventListener('hashchange', router);
    window.addEventListener('load', router);
  })();
  </script>
</body>
</html>